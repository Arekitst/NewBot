import logging
import random
from datetime import datetime
import os
import json
import asyncio

import asyncpg
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command, CommandObject, or_f
from aiogram.types import CallbackQuery, Message, LabeledPrice, PreCheckoutQuery
from aiogram.enums import ChatMemberStatus, ParseMode
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.exceptions import TelegramBadRequest
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(name)s - %(message)s')
logger = logging.getLogger(__name__)

# --- –ù–ê–°–¢–†–û–ô–ö–ò –ë–û–¢–ê (–ò–ó –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø) ---
BOT_TOKEN = os.getenv("BOT_TOKEN")
DATABASE_URL = os.getenv("DB_URL")

if not BOT_TOKEN or not DATABASE_URL:
    logger.critical("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN –∏/–∏–ª–∏ DB_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.")
    exit()

ADMIN_IDS = [6179115044, 7189733067]

# --- –°–ü–ò–°–û–ö –í–û–ü–†–û–°–û–í –î–õ–Ø –í–ò–ö–¢–û–†–ò–ù–´ ---
QUIZ_QUESTIONS = [
    ("–ö–∞–∫–∞—è –∑–º–µ—è —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–∞–º–æ–π —è–¥–æ–≤–∏—Ç–æ–π –≤ –º–∏—Ä–µ?", json.dumps(["–¢–∞–π–ø–∞–Ω", "–ß–µ—Ä–Ω–∞—è –º–∞–º–±–∞", "–ì–∞–¥—é–∫–∞", "–ö–æ–±—Ä–∞"]), "–¢–∞–π–ø–∞–Ω"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –≤ –º–∏—Ä–µ?", json.dumps(["–ê–Ω–∞–∫–æ–Ω–¥–∞", "–°–µ—Ç—á–∞—Ç—ã–π –ø–∏—Ç–æ–Ω", "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞", "–¢–∏–≥—Ä–æ–≤—ã–π –ø–∏—Ç–æ–Ω"]), "–°–µ—Ç—á–∞—Ç—ã–π –ø–∏—Ç–æ–Ω"),
    ("–ï—Å—Ç—å –ª–∏ —É –∑–º–µ–π —É—à–∏?", json.dumps(["–î–∞, –Ω–æ –æ–Ω–∏ —Å–∫—Ä—ã—Ç—ã", "–¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Ö–æ", "–ù–µ—Ç", "–î–∞, –∫–∞–∫ —É —è—â–µ—Ä–∏—Ü"]), "–¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Ö–æ"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Å–∞–º—ã–µ –±–æ–ª—å—à–∏–µ —è–π—Ü–∞?", json.dumps(["–ü–∏—Ç–æ–Ω", "–ê–Ω–∞–∫–æ–Ω–¥–∞", "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞", "–£–¥–∞–≤"]), "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞"),
    ("–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∑–º–µ—è–º '–Ω—é—Ö–∞—Ç—å' —è–∑—ã–∫–æ–º?", json.dumps(["–û—Ä–≥–∞–Ω –Ø–∫–æ–±—Å–æ–Ω–∞", "–ù–æ–∑–¥—Ä–∏", "–¢–µ—Ä–º–æ—Ä–µ—Ü–µ–ø—Ç–æ—Ä—ã", "–ö–æ–Ω—á–∏–∫ —è–∑—ã–∫–∞"]), "–û—Ä–≥–∞–Ω –Ø–∫–æ–±—Å–æ–Ω–∞"),
    ("–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —Å–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è –∫–æ–∂–∏ —É –∑–º–µ–π?", json.dumps(["–õ–∏–Ω—å–∫–∞", "–ú–µ—Ç–∞–º–æ—Ä—Ñ–æ–∑–∞", "–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è", "–ê–Ω–∞–±–∏–æ–∑"]), "–õ–∏–Ω—å–∫–∞"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —Å–ø–æ—Å–æ–±–Ω–∞ '–ø–ª–µ–≤–∞—Ç—å—Å—è' —è–¥–æ–º?", json.dumps(["–û—à–µ–π–Ω–∏–∫–æ–≤–∞—è –∫–æ–±—Ä–∞", "–ì–∞–¥—é–∫–∞ –†–∞—Å—Å–µ–ª–∞", "–ë—É—à–º–µ–π—Å—Ç–µ—Ä", "–≠—Ñ–∞"]), "–û—à–µ–π–Ω–∏–∫–æ–≤–∞—è –∫–æ–±—Ä–∞"),
    ("–°–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤–∏–¥–æ–≤ –∑–º–µ–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –º–∏—Ä–µ?", json.dumps(["–û–∫–æ–ª–æ 1000", "–û–∫–æ–ª–æ 2000", "–û–∫–æ–ª–æ 3500", "–ë–æ–ª–µ–µ 5000"]), "–û–∫–æ–ª–æ 3500"),
    ("–ö–∞–∫–∞—è –∏–∑ —ç—Ç–∏—Ö –∑–º–µ–π –Ω–µ —è–¥–æ–≤–∏—Ç–∞?", json.dumps(["–ú–æ–ª–æ—á–Ω–∞—è –∑–º–µ—è", "–ö–æ—Ä–∞–ª–ª–æ–≤—ã–π –∞—Å–ø–∏–¥", "–¢–∞–π–ø–∞–Ω", "–ú–æ—Ä—Å–∫–∞—è –∑–º–µ—è"]), "–ú–æ–ª–æ—á–Ω–∞—è –∑–º–µ—è"),
    ("–ö–∞–∫—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –º–æ–∂–µ—Ç —Ä–∞–∑–≤–∏—Ç—å –ß–µ—Ä–Ω–∞—è –º–∞–º–±–∞?", json.dumps(["–î–æ 5 –∫–º/—á", "–î–æ 10 –∫–º/—á", "–î–æ 20 –∫–º/—á", "–î–æ 30 –∫–º/—á"]), "–î–æ 20 –∫–º/—á"),
    ("–ß—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –ù–ï –µ–¥—è—Ç –∑–º–µ–∏?", json.dumps(["–ü—Ç–∏—Ü", "–Ø–π—Ü–∞", "–†—ã–±—É", "–¢—Ä–∞–≤—É"]), "–¢—Ä–∞–≤—É"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –∏–∑–≤–µ—Å—Ç–Ω–∞ —Å–≤–æ–∏–º '–∫–∞–ø—é—à–æ–Ω–æ–º'?", json.dumps(["–ö–æ–±—Ä–∞", "–ú–∞–º–±–∞", "–£–¥–∞–≤", "–ü–∏—Ç–æ–Ω"]), "–ö–æ–±—Ä–∞"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —Å—Ç—Ä–æ–∏—Ç –≥–Ω–µ–∑–¥–∞ –¥–ª—è —Å–≤–æ–∏—Ö —è–∏—Ü?", json.dumps(["–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞", "–ß–µ—Ä–Ω–∞—è –º–∞–º–±–∞", "–ü–∏—Ç–æ–Ω", "–ê–Ω–∞–∫–æ–Ω–¥–∞"]), "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞"),
    ("–ö–∞–∫–æ–µ —á—É–≤—Å—Ç–≤–æ —É –∑–º–µ–π —Ä–∞–∑–≤–∏—Ç–æ —Å–ª–∞–±–µ–µ –≤—Å–µ–≥–æ?", json.dumps(["–ó—Ä–µ–Ω–∏–µ", "–°–ª—É—Ö", "–û–±–æ–Ω—è–Ω–∏–µ", "–û—Å—è–∑–∞–Ω–∏–µ"]), "–°–ª—É—Ö"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –º–æ–∂–µ—Ç '—Å–∫–æ–ª—å–∑–∏—Ç—å' –ø–æ –≤–æ–∑–¥—É—Ö—É –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ 100 –º–µ—Ç—Ä–æ–≤?", json.dumps(["–£–∫—Ä–∞—à–µ–Ω–Ω–∞—è –¥—Ä–µ–≤–µ—Å–Ω–∞—è –∑–º–µ—è", "–†–∞–π—Å–∫–∞—è –¥—Ä–µ–≤–µ—Å–Ω–∞—è –∑–º–µ—è", "–õ–µ—Ç—É—á–∞—è –∑–º–µ—è", "–í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–µ—Ä–Ω—ã"]), "–í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–µ—Ä–Ω—ã"),
    ("–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç '—É–∫—É—Å –±–µ–∑ –≤–ø—Ä—ã—Å–∫–∏–≤–∞–Ω–∏—è —è–¥–∞'?", json.dumps(["–ü—Ä–æ–º–∞—Ö", "–°—É—Ö–æ–π —É–∫—É—Å", "–ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π —É–∫—É—Å", "–ù–µ–ø–æ–ª–Ω—ã–π —É–∫—É—Å"]), "–°—É—Ö–æ–π —É–∫—É—Å"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º–æ–π —Ç—è–∂–µ–ª–æ–π –≤ –º–∏—Ä–µ?", json.dumps(["–°–µ—Ç—á–∞—Ç—ã–π –ø–∏—Ç–æ–Ω", "–ó–µ–ª–µ–Ω–∞—è –∞–Ω–∞–∫–æ–Ω–¥–∞", "–¢–∏–≥—Ä–æ–≤—ã–π –ø–∏—Ç–æ–Ω", "–¢–µ–º–Ω—ã–π —Ç–∏–≥—Ä–æ–≤—ã–π –ø–∏—Ç–æ–Ω"]), "–ó–µ–ª–µ–Ω–∞—è –∞–Ω–∞–∫–æ–Ω–¥–∞"),
    ("–°–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–∏—Ö —É –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–º–µ–π?", json.dumps(["–û–¥–Ω–æ", "–î–≤–∞, –Ω–æ –æ–¥–Ω–æ —Ä—É–¥–∏–º–µ–Ω—Ç–∞—Ä–Ω–æ–µ", "–î–≤–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö", "–ù–∏ –æ–¥–Ω–æ–≥–æ"]), "–î–≤–∞, –Ω–æ –æ–¥–Ω–æ —Ä—É–¥–∏–º–µ–Ω—Ç–∞—Ä–Ω–æ–µ"),
    ("–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–º–µ—è, –∫–æ—Ç–æ—Ä–∞—è –∏–º–∏—Ç–∏—Ä—É–µ—Ç –æ–∫—Ä–∞—Å–∫—É —è–¥–æ–≤–∏—Ç–æ–≥–æ –∫–æ—Ä–∞–ª–ª–æ–≤–æ–≥–æ –∞—Å–ø–∏–¥–∞?", json.dumps(["–ú–æ–ª–æ—á–Ω–∞—è –∑–º–µ—è", "–ü–æ–¥–≤—è–∑–æ—á–Ω–∞—è –∑–º–µ—è", "–ö—É–∫—É—Ä—É–∑–Ω—ã–π –ø–æ–ª–æ–∑", "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∑–º–µ—è"]), "–ú–æ–ª–æ—á–Ω–∞—è –∑–º–µ—è"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –∏–º–µ–µ—Ç —Å–∞–º—ã–µ –¥–ª–∏–Ω–Ω—ã–µ —è–¥–æ–≤–∏—Ç—ã–µ –∑—É–±—ã (–¥–æ 5 —Å–º)?", json.dumps(["–ì—é—Ä–∑–∞", "–ë—É—à–º–µ–π—Å—Ç–µ—Ä", "–ì–∞–±–æ–Ω—Å–∫–∞—è –≥–∞–¥—é–∫–∞", "–¢–∞–π–ø–∞–Ω"]), "–ì–∞–±–æ–Ω—Å–∫–∞—è –≥–∞–¥—é–∫–∞"),
    ("–î–ª—è —á–µ–≥–æ –∑–º–µ–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–≤–æ–π —Ä–∞–∑–¥–≤–æ–µ–Ω–Ω—ã–π —è–∑—ã–∫?", json.dumps(["–î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∞—Ö–∞", "–î–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –¥–æ–±—ã—á–∏", "–î–ª—è –∑–∞—â–∏—Ç—ã", "–î–ª—è –ø–∏—Ç—å—è"]), "–î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∞—Ö–∞"),
    ("–ö–∞–∫–æ–π –≤–∏–¥ –∑–º–µ–π —á–∞—Å—Ç–æ –¥–µ—Ä–∂–∞—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –¥–æ–º–∞—à–Ω–∏—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ –∏–∑-–∑–∞ –∏—Ö —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ –Ω—Ä–∞–≤–∞?", json.dumps(["–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –ø–∏—Ç–æ–Ω", "–¢–∏–≥—Ä–æ–≤—ã–π –ø–∏—Ç–æ–Ω", "–†–∞–¥—É–∂–Ω—ã–π —É–¥–∞–≤", "–í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–µ—Ä–Ω—ã"]), "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –ø–∏—Ç–æ–Ω"),
    ("–°—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ –∑–º–µ–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–∏—Ç–∞—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥—Ä—É–≥–∏–º–∏ –∑–º–µ—è–º–∏?", json.dumps(["–î–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞", "–ù–µ—Ç, –≤—Å–µ –∑–º–µ–∏ –µ–¥—è—Ç –≥—Ä—ã–∑—É–Ω–æ–≤", "–¢–æ–ª—å–∫–æ –≤ –º–∏—Ñ–æ–ª–æ–≥–∏–∏", "–î–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–≤–æ–ª–µ"]), "–î–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞"),
    ("–ö–∞–∫ –∑–º–µ–∏ '—Å–ª—ã—à–∞—Ç' –±–µ–∑ —É—à–Ω—ã—Ö —Ä–∞–∫–æ–≤–∏–Ω?", json.dumps(["–ß–µ—Ä–µ–∑ –≤–∏–±—Ä–∞—Ü–∏–∏ –ø–æ—á–≤—ã –∏ –∫–æ—Å—Ç–µ–π —á–µ—Ä–µ–ø–∞", "–£ –Ω–∏—Ö –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —É—à–∏ –ø–æ–¥ –∫–æ–∂–µ–π", "–û–Ω–∏ –Ω–µ —Å–ª—ã—à–∞—Ç –≤–æ–æ–±—â–µ", "–° –ø–æ–º–æ—â—å—é —è–∑—ã–∫–∞"]), "–ß–µ—Ä–µ–∑ –≤–∏–±—Ä–∞—Ü–∏–∏ –ø–æ—á–≤—ã –∏ –∫–æ—Å—Ç–µ–π —á–µ—Ä–µ–ø–∞"),
    ("–ö–∞–∫–∞—è –∏–∑ —ç—Ç–∏—Ö –∑–º–µ–π –∂–∏–≤–æ—Ä–æ–¥—è—â–∞—è, –∞ –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç —è–π—Ü–∞?", json.dumps(["–û–±—ã–∫–Ω–æ–≤–µ–Ω–Ω–∞—è –≥–∞–¥—é–∫–∞", "–ö—É–∫—É—Ä—É–∑–Ω—ã–π –ø–æ–ª–æ–∑", "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –ø–∏—Ç–æ–Ω", "–£–∂ –æ–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–π"]), "–û–±—ã–∫–Ω–æ–≤–µ–Ω–Ω–∞—è –≥–∞–¥—é–∫–∞"),
    ("–ì–¥–µ –æ–±–∏—Ç–∞–µ—Ç —Å–∞–º–∞—è –º–∞–ª–µ–Ω—å–∫–∞—è –∑–º–µ—è –≤ –º–∏—Ä–µ, —É–∑–∫–æ—Ä–æ—Ç–∞—è –∑–º–µ—è –ö–∞—Ä–ª—ã?", json.dumps(["–ù–∞ –æ—Å—Ç—Ä–æ–≤–µ –ë–∞—Ä–±–∞–¥–æ—Å", "–í –¥–∂—É–Ω–≥–ª—è—Ö –ê–º–∞–∑–æ–Ω–∫–∏", "–í –ø—É—Å—Ç—ã–Ω–µ –°–∞—Ö–∞—Ä–∞", "–ù–∞ –ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä–µ"]), "–ù–∞ –æ—Å—Ç—Ä–æ–≤–µ –ë–∞—Ä–±–∞–¥–æ—Å"),
    ("–ß—Ç–æ —Ç–∞–∫–æ–µ '—Ç–µ—Ä–º–æ–ª–æ–∫–∞—Ü–∏—è' —É –∑–º–µ–π?", json.dumps(["–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–∏–¥–µ—Ç—å –≤ —Ç–µ–º–Ω–æ—Ç–µ", "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–ø–ª–æ", "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –º–∞–≥–Ω–∏—Ç–Ω–æ–º—É –ø–æ–ª—é", "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–µ–Ω—è—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç–µ–ª–∞"]), "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–ø–ª–æ"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —Å–ø–æ—Å–æ–±–Ω–∞ –º–µ–Ω—è—Ç—å —Ü–≤–µ—Ç –∫–æ–∂–∏?", json.dumps(["–ì–∞–¥—é–∫–∞ –Ω–æ—Å–∞—Ç–∞—è", "–ó–µ–ª–µ–Ω—ã–π –ø–∏—Ç–æ–Ω", "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥—ã —É–¥–∞–≤–æ–≤", "–ù–∏–∫–∞–∫–∞—è"]), "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥—ã —É–¥–∞–≤–æ–≤"),
    ("–ß—Ç–æ —Ç–∞–∫–æ–µ '–∞–≤—Ç–æ—Ç–æ–º–∏—è' —É –∑–º–µ–π?", json.dumps(["–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ—Ç—Ä–∞—â–∏–≤–∞—Ç—å —Ö–≤–æ—Å—Ç", "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ö–≤–æ—Å—Ç", "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞—Ç—å –∫–æ—Å—Ç–∏", "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —É –∑–º–µ–π"]), "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —É –∑–º–µ–π"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —è–≤–ª—è–µ—Ç—Å—è —Å–∏–º–≤–æ–ª–æ–º –º–µ–¥–∏—Ü–∏–Ω—ã?", json.dumps(["–≠—Å–∫—É–ª–∞–ø–æ–≤ –ø–æ–ª–æ–∑", "–ì–∞–¥—é–∫–∞ –ê—Å–∫–ª–µ–ø–∏—è", "–ö–æ–±—Ä–∞", "–£–∂"]), "–≠—Å–∫—É–ª–∞–ø–æ–≤ –ø–æ–ª–æ–∑"),
    ("–°–∫–æ–ª—å–∫–æ –ø–æ–∑–≤–æ–Ω–∫–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å —É –∑–º–µ–∏?", json.dumps(["–î–æ 100", "–î–æ 200", "–î–æ 400 –∏ –±–æ–ª–µ–µ", "–í—Å–µ–≥–¥–∞ 33, –∫–∞–∫ —É —á–µ–ª–æ–≤–µ–∫–∞"]), "–î–æ 400 –∏ –±–æ–ª–µ–µ"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —è–¥–æ–≤–∏—Ç–æ–π?", json.dumps(["–ó–µ–ª–µ–Ω–∞—è –º–∞–º–±–∞", "–ë—É–º—Å–ª–∞–Ω–≥", "–ò–∑—É–º—Ä—É–¥–Ω—ã–π –¥—Ä–µ–≤–µ—Å–Ω—ã–π —É–¥–∞–≤", "–¢–∏–≥—Ä–æ–≤–∞—è –∑–º–µ—è"]), "–ò–∑—É–º—Ä—É–¥–Ω—ã–π –¥—Ä–µ–≤–µ—Å–Ω—ã–π —É–¥–∞–≤"),
    ("–ö–∞–∫–æ–π –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º, –≥–¥–µ –Ω–µ—Ç –∫–æ—Ä–µ–Ω–Ω—ã—Ö –≤–∏–¥–æ–≤ –∑–º–µ–π?", json.dumps(["–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "–ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞", "–ï–≤—Ä–æ–ø–∞", "–°–µ–≤–µ—Ä–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞"]), "–ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞"),
    ("–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞—É–∫–∞, –∏–∑—É—á–∞—é—â–∞—è –∑–º–µ–π?", json.dumps(["–ì–µ—Ä–ø–µ—Ç–æ–ª–æ–≥–∏—è", "–°–µ—Ä–ø–µ–Ω—Ç–æ–ª–æ–≥–∏—è", "–û—Ñ–∏–æ–ª–æ–≥–∏—è", "–í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–µ—Ä–Ω—ã"]), "–í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–µ—Ä–Ω—ã"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –∏–º–µ–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π '—Ä–æ–≥' –Ω–∞ –Ω–æ—Å—É?", json.dumps(["–†–æ–≥–∞—Ç–∞—è –≥–∞–¥—é–∫–∞", "–ù–æ—Å–∞—Ç–∞—è –≥–∞–¥—é–∫–∞", "–û–±–µ –∑–º–µ–∏", "–ù–∏ –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö"]), "–û–±–µ –∑–º–µ–∏"),
    ("–ß—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∏—Ç–æ–Ω–∞–º –∑–∞–≥–ª–∞—Ç—ã–≤–∞—Ç—å –¥–æ–±—ã—á—É –Ω–∞–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –∏—Ö –≥–æ–ª–æ–≤—ã?", json.dumps(["–≠–ª–∞—Å—Ç–∏—á–Ω—ã–µ —Å–≤—è–∑–∫–∏ —á–µ–ª—é—Å—Ç–∏", "–û–Ω–∏ —Ä–∞–∑—Ä—ã–≤–∞—é—Ç –¥–æ–±—ã—á—É –Ω–∞ –∫—É—Å–∫–∏", "–£ –Ω–∏—Ö –Ω–µ—Ç —á–µ–ª—é—Å—Ç–Ω—ã—Ö –∫–æ—Å—Ç–µ–π", "–û–Ω–∏ –≤–ø—Ä—ã—Å–∫–∏–≤–∞—é—Ç —Ä–∞–∑–∂–∏–∂–∞—é—â–∏–π —Ñ–µ—Ä–º–µ–Ω—Ç"]), "–≠–ª–∞—Å—Ç–∏—á–Ω—ã–µ —Å–≤—è–∑–∫–∏ —á–µ–ª—é—Å—Ç–∏"),
    ("–ö–∞–∫–∞—è —Å—Ç—Ä–∞–Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω–∞ –ø–æ–ª–Ω—ã–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –∑–º–µ–π, —Å–æ–≥–ª–∞—Å–Ω–æ –ª–µ–≥–µ–Ω–¥–µ?", json.dumps(["–ò—Å–ª–∞–Ω–¥–∏—è", "–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è", "–ò—Ä–ª–∞–Ω–¥–∏—è", "–ì—Ä–µ–Ω–ª–∞–Ω–¥–∏—è"]), "–ò—Ä–ª–∞–Ω–¥–∏—è"),
    ("–Ø–¥ –∫–∞–∫–æ–π –∑–º–µ–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –º–µ–¥–∏—Ü–∏–Ω–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–µ–∫–∞—Ä—Å—Ç–≤?", json.dumps(["–ì—é—Ä–∑—ã", "–ö–æ–±—Ä—ã", "–ì–∞–¥—é–∫–∏", "–í—Å–µ—Ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö"]), "–í—Å–µ—Ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö"),
    ("–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞—â–∏—Ç–Ω–∞—è –ø–æ–∑–∞ –∫–æ–±—Ä—ã, –∫–æ–≥–¥–∞ –æ–Ω–∞ —Ä–∞–∑–¥—É–≤–∞–µ—Ç –∫–∞–ø—é—à–æ–Ω?", json.dumps(["–ê—Ç–∞–∫—É—é—â–∞—è —Å—Ç–æ–π–∫–∞", "–û–±–æ—Ä–æ–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è", "–ë—Ä–∞—á–Ω—ã–π —Ç–∞–Ω–µ—Ü", "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ"]), "–û–±–æ—Ä–æ–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –º–æ–∂–µ—Ç –∏–∑–¥–∞–≤–∞—Ç—å –∑–≤—É–∫, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ —à–∏–ø–µ–Ω–∏–µ –∫–æ—à–∫–∏?", json.dumps(["–®–∏–ø—è—â–∞—è –≥–∞–¥—é–∫–∞", "–≠—Ñ–∞", "–ö–≤–∞–∫–µ—Ä", "–ù–∏–∫–∞–∫–∞—è"]), "–®–∏–ø—è—â–∞—è –≥–∞–¥—é–∫–∞"),
    ("–ö–∞–∫–æ–π –≤–∏–¥ –∑–º–µ–π —è–≤–ª—è–µ—Ç—Å—è –≤–æ–¥–Ω—ã–º –∏ –ø–æ—á—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —Å—É—à—É?", json.dumps(["–ú–æ—Ä—Å–∫–∏–µ –∑–º–µ–∏ (–ª–∞—Å—Ç–æ—Ö–≤–æ—Å—Ç—ã)", "–ê–Ω–∞–∫–æ–Ω–¥—ã", "–í–æ–¥—è–Ω—ã–µ —É–∂–∏", "–í—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ"]), "–ú–æ—Ä—Å–∫–∏–µ –∑–º–µ–∏ (–ª–∞—Å—Ç–æ—Ö–≤–æ—Å—Ç—ã)"),
    ("–ß—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Ä–∞—Ü–∏–æ–Ω —è–∏—á–Ω–æ–π –∑–º–µ–∏?", json.dumps(["–ü—Ç–∏—á—å–∏ —è–π—Ü–∞", "–Ø–π—Ü–∞ —è—â–µ—Ä–∏—Ü", "–ú—ã—à–∏", "–Ø–π—Ü–∞ —á–µ—Ä–µ–ø–∞—Ö"]), "–ú—ã—à–∏"),
    ("–ö–∞–∫–æ–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–∞ –∑–∞ –æ–¥–∏–Ω —É–∫—É—Å –º–æ–∂–µ—Ç –≤—ã–¥–µ–ª–∏—Ç—å –∫–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞?", json.dumps(["–î–æ 1 –º–ª", "–î–æ 3 –º–ª", "–î–æ 7 –º–ª", "–î–æ 15 –º–ª"]), "–î–æ 7 –º–ª"),
    ("–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –∑–º–µ—è '—Ä–æ–∂–∞–µ—Ç' –∂–∏–≤—ã—Ö –¥–µ—Ç–µ–Ω—ã—à–µ–π?", json.dumps(["–Ø–π—Ü–µ–∂–∏–≤–æ—Ä–æ–∂–¥–µ–Ω–∏–µ", "–ñ–∏–≤–æ—Ä–æ–∂–¥–µ–Ω–∏–µ", "–û–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤–µ—Ä–Ω—ã", "–¢–∞–∫–æ–≥–æ –Ω–µ –±—ã–≤–∞–µ—Ç"]), "–û–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤–µ—Ä–Ω—ã"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –∏–º–µ–µ—Ç —Å–∞–º—ã–π –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤—É—é—â–∏–π —è–¥?", json.dumps(["–¢–∞–π–ø–∞–Ω –ú–∞–∫–∫–æ—è", "–ß–µ—Ä–Ω–∞—è –º–∞–º–±–∞", "–ú–æ—Ä—Å–∫–∞—è –∑–º–µ—è –ë–µ–ª—á–µ—Ä–∞", "–ö—Ä—é—á–∫–æ–Ω–æ—Å–∞—è –º–æ—Ä—Å–∫–∞—è –∑–º–µ—è"]), "–¢–∞–π–ø–∞–Ω –ú–∞–∫–∫–æ—è"),
    ("–£ –∫–∞–∫–æ–π –∑–º–µ–∏ –Ω–∞ —Ö–≤–æ—Å—Ç–µ –µ—Å—Ç—å '–ø–æ–≥—Ä–µ–º—É—à–∫–∞'?", json.dumps(["–ì—Ä–µ–º—É—á–∞—è –∑–º–µ—è", "–©–∏—Ç–æ–º–æ—Ä–¥–Ω–∏–∫", "–≠—Ñ–∞", "–í—Å–µ –≥–∞–¥—é–∫–æ–≤—ã–µ"]), "–ì—Ä–µ–º—É—á–∞—è –∑–º–µ—è"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –º–æ–∂–µ—Ç '–ø–ª–µ–≤–∞—Ç—å—Å—è' —è–¥–æ–º –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ 3 –º–µ—Ç—Ä–æ–≤?", json.dumps(["–û—à–µ–π–Ω–∏–∫–æ–≤–∞—è –∫–æ–±—Ä–∞", "–ú–æ–∑–∞–º–±–∏–∫—Å–∫–∞—è –∫–æ–±—Ä–∞", "–ß–µ—Ä–Ω–æ—à–µ—è—è –∫–æ–±—Ä–∞", "–í—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ"]), "–í—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —Å—á–∏—Ç–∞–µ—Ç—Å—è '–∫–æ—Ä–æ–ª–µ–≤–æ–π' –∫–∞–º—É—Ñ–ª—è–∂–∞?", json.dumps(["–ì–∞–±–æ–Ω—Å–∫–∞—è –≥–∞–¥—é–∫–∞", "–õ–∏—Å—Ç–æ–Ω–æ—Å–∞—è –∑–º–µ—è", "–ü–µ—Å—á–∞–Ω–∞—è —ç—Ñ–∞", "–ó–µ–ª–µ–Ω—ã–π –ø–∏—Ç–æ–Ω"]), "–ì–∞–±–æ–Ω—Å–∫–∞—è –≥–∞–¥—é–∫–∞"),
    ("–°—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ —Å–ª–µ–ø—ã–µ –∑–º–µ–∏?", json.dumps(["–î–∞, –±—Ä–∞–º–∏–Ω–∏–π—Å–∫–∏–π —Å–ª–µ–ø—É–Ω", "–ù–µ—Ç, —É –≤—Å–µ—Ö –∑–º–µ–π –µ—Å—Ç—å –≥–ª–∞–∑–∞", "–¢–æ–ª—å–∫–æ –≤ –≥–ª—É–±–æ–∫–∏—Ö –ø–µ—â–µ—Ä–∞—Ö", "–î–∞, –Ω–æ –æ–Ω–∏ –≤—ã–º–µ—Ä–ª–∏"]), "–î–∞, –±—Ä–∞–º–∏–Ω–∏–π—Å–∫–∏–π —Å–ª–µ–ø—É–Ω"),
    ("–ö–∞–∫ –¥–æ–ª–≥–æ –∑–º–µ—è –º–æ–∂–µ—Ç –æ–±—Ö–æ–¥–∏—Ç—å—Å—è –±–µ–∑ –µ–¥—ã –ø–æ—Å–ª–µ –∫—Ä—É–ø–Ω–æ–π –¥–æ–±—ã—á–∏?", json.dumps(["–ù–µ–¥–µ–ª—é", "–ú–µ—Å—è—Ü", "–ù–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ –∏ –¥–æ–ª—å—à–µ", "–¢—Ä–∏ –¥–Ω—è"]), "–ù–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ –∏ –¥–æ–ª—å—à–µ"),
    ("–ö–∞–∫–∞—è —á–∞—Å—Ç—å —Ç–µ–ª–∞ –∑–º–µ–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞—Å—Ç–∏ –≤—Å—é –∂–∏–∑–Ω—å?", json.dumps(["–•–≤–æ—Å—Ç", "–ì–æ–ª–æ–≤–∞", "–í—Å—ë —Ç–µ–ª–æ", "–ù–∏—á–µ–≥–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ"]), "–í—Å—ë —Ç–µ–ª–æ"),
    ("–ß—Ç–æ —Ç–∞–∫–æ–µ '–º—É—Å–∫—É—Å–Ω—ã–π –∑–∞–ø–∞—Ö', –≤—ã–¥–µ–ª—è–µ–º—ã–π –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –∑–º–µ—è–º–∏?", json.dumps(["–°—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤", "–ó–∞—â–∏—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –æ—Ç–ø—É–≥–∏–≤–∞–Ω–∏—è —Ö–∏—â–Ω–∏–∫–æ–≤", "–°–ø–æ—Å–æ–± –º–µ—Ç–∏—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é", "–ü–æ–±–æ—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è"]), "–ó–∞—â–∏—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –æ—Ç–ø—É–≥–∏–≤–∞–Ω–∏—è —Ö–∏—â–Ω–∏–∫–æ–≤"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π —è–¥–æ–≤–∏—Ç–æ–π –∑–º–µ–µ–π –≤ –º–∏—Ä–µ?", json.dumps(["–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞", "–ß–µ—Ä–Ω–∞—è –º–∞–º–±–∞", "–¢–∞–π–ø–∞–Ω", "–ë—É—à–º–µ–π—Å—Ç–µ—Ä"]), "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞"),
    ("–í –∫–∞–∫–æ–π —Å—Ä–µ–¥–µ –æ–±–∏—Ç–∞–µ—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –≤–∏–¥–æ–≤ –∑–º–µ–π?", json.dumps(["–í –ª–µ—Å–∞—Ö", "–í –ø—É—Å—Ç—ã–Ω—è—Ö", "–í –≤–æ–¥–µ", "–í –≥–æ—Ä–∞—Ö"]), "–í –ª–µ—Å–∞—Ö"),
    ("–ü–æ—á–µ–º—É —è–∑—ã–∫ –∑–º–µ–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏?", json.dumps(["–î–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥–µ", "–î–ª—è –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è", "–≠—Ç–æ –Ω–µ—Ä–≤–Ω—ã–π —Ç–∏–∫", "–î–ª—è –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏"]), "–î–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥–µ"),
    ("–ö–∞–∫–∞—è –∏–∑ —ç—Ç–∏—Ö –∑–º–µ–π –Ω–µ –¥—É—à–∏—Ç —Å–≤–æ—é –¥–æ–±—ã—á—É?", json.dumps(["–ü–∏—Ç–æ–Ω", "–£–¥–∞–≤", "–ì–∞–¥—é–∫–∞", "–ê–Ω–∞–∫–æ–Ω–¥–∞"]), "–ì–∞–¥—é–∫–∞"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –∏–∑–≤–µ—Å—Ç–Ω–∞ —Å–≤–æ–µ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é '—Ö–æ–¥–∏—Ç—å –ø–æ –≤–æ–¥–µ' (—Å–∫–æ–ª—å–∑–∏—Ç—å –ø–æ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏)?", json.dumps(["–í–∞—Å–∏–ª–∏—Å–∫", "–í–æ–¥—è–Ω–æ–π —â–∏—Ç–æ–º–æ—Ä–¥–Ω–∏–∫", "–ó–º–µ—è-—Ä—ã–±–æ–ª–æ–≤", "–ù–∏–∫–∞–∫–∞—è, —ç—Ç–æ –º–∏—Ñ"]), "–í–æ–¥—è–Ω–æ–π —â–∏—Ç–æ–º–æ—Ä–¥–Ω–∏–∫"),
    ("–ö–∞–∫–æ–≥–æ —Ü–≤–µ—Ç–∞ –∫—Ä–æ–≤—å —É –∑–º–µ–π?", json.dumps(["–ö—Ä–∞—Å–Ω–∞—è", "–°–∏–Ω—è—è", "–ó–µ–ª–µ–Ω–∞—è", "–ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è"]), "–ö—Ä–∞—Å–Ω–∞—è"),
    ("–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –≥–æ–¥ –∑–º–µ—è –º–æ–∂–µ—Ç –ª–∏–Ω—è—Ç—å?", json.dumps(["–û–¥–∏–Ω —Ä–∞–∑", "–î–≤–∞ —Ä–∞–∑–∞", "–û—Ç 2 –¥–æ 12 —Ä–∞–∑, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –≤–∏–¥–∞", "–¢–æ–ª—å–∫–æ –≤ –¥–µ—Ç—Å—Ç–≤–µ"]), "–û—Ç 2 –¥–æ 12 —Ä–∞–∑, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –≤–∏–¥–∞"),
    ("–ö–∞–∫–æ–π –≤–∏–¥ –∑–º–µ–π –∏–∑–≤–µ—Å—Ç–µ–Ω —Ç–µ–º, —á—Ç–æ '–∑–∞–±–æ—Ç–∏—Ç—Å—è' –æ —Å–≤–æ–µ–º –ø–æ—Ç–æ–º—Å—Ç–≤–µ –ø–æ—Å–ª–µ —Ä–æ–∂–¥–µ–Ω–∏—è?", json.dumps(["–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –∫–æ–±—Ä–∞", "–ü–∏—Ç–æ–Ω", "–ì–∞–¥—é–∫–∞", "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∫–∞–∫–æ–π"]), "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∫–∞–∫–æ–π"),
    ("–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –µ—Å–ª–∏ –≥—Ä–µ–º—É—á–∞—è –∑–º–µ—è —É–∫—É—Å–∏—Ç —Å–∞–º—É —Å–µ–±—è?", json.dumps(["–û–Ω–∞ —É–º—Ä–µ—Ç", "–ù–∏—á–µ–≥–æ, —É –Ω–µ–µ –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ —Å–≤–æ–µ–º—É —è–¥—É", "–û–Ω–∞ –∑–∞–±–æ–ª–µ–µ—Ç, –Ω–æ –≤—ã–∂–∏–≤–µ—Ç", "–¢–∞–∫–æ–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ"]), "–ù–∏—á–µ–≥–æ, —É –Ω–µ–µ –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ —Å–≤–æ–µ–º—É —è–¥—É"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è –≤–ø–∞–¥–∞–µ—Ç –≤ —Å–ø—è—á–∫—É –∑–∏–º–æ–π –≤ —É–º–µ—Ä–µ–Ω–Ω—ã—Ö —à–∏—Ä–æ—Ç–∞—Ö?", json.dumps(["–ì–∞–¥—é–∫–∏", "–£–∂–∏", "–ú–µ–¥—è–Ω–∫–∏", "–í—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ"]), "–í—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ"),
    ("–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, –∫–æ–≥–¥–∞ –∑–º–µ—è —à–∏–ø–∏—Ç?", json.dumps(["–≠—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ", "–û–Ω–∞ –¥—ã—à–∏—Ç", "–û–Ω–∞ –∑–ª–∏—Ç—Å—è", "–í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–µ—Ä–Ω—ã"]), "–í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–µ—Ä–Ω—ã"),
    ("–£ –∫–∞–∫–æ–π –∑–º–µ–∏ —è–¥ –æ–±–ª–∞–¥–∞–µ—Ç –Ω–µ–π—Ä–æ—Ç–æ–∫—Å–∏—á–µ—Å–∫–∏–º –¥–µ–π—Å—Ç–≤–∏–µ–º, –ø–∞—Ä–∞–ª–∏–∑—É—è –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É?", json.dumps(["–ö–æ–±—Ä—ã –∏ –º–∞–º–±—ã", "–ì–∞–¥—é–∫–∏", "–ì—Ä–µ–º—É—á–∏–µ –∑–º–µ–∏", "–í—Å–µ —è–¥–æ–≤–∏—Ç—ã–µ –∑–º–µ–∏"]), "–ö–æ–±—Ä—ã –∏ –º–∞–º–±—ã"),
    ("–ö–∞–∫–∞—è –∑–º–µ—è —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –≥–æ—Ä–æ–¥—Å–∫–∏—Ö –ø–∞—Ä–∫–∞—Ö –∏ —Å–∞–¥–∞—Ö –ï–≤—Ä–æ–ø—ã?", json.dumps(["–û–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–π —É–∂", "–ú–µ–¥—è–Ω–∫–∞", "–ì–∞–¥—é–∫–∞ –ù–∏–∫–æ–ª—å—Å–∫–æ–≥–æ", "–≠—Å–∫—É–ª–∞–ø–æ–≤ –ø–æ–ª–æ–∑"]), "–û–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–π —É–∂"),
    ("–ß—Ç–æ —Ç–∞–∫–æ–µ '—Ç–µ–ø–ª–æ–≤—ã–µ —è–º–∫–∏' —É –∑–º–µ–π?", json.dumps(["–û—Ä–≥–∞–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤–æ–¥—ã", "–û—Ä–≥–∞–Ω—ã –∏–Ω—Ñ—Ä–∞–∫—Ä–∞—Å–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è", "–ú–µ—Å—Ç–∞ –¥–ª—è –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è —è–∏—Ü", "–£–≥–ª—É–±–ª–µ–Ω–∏—è –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏"]), "–û—Ä–≥–∞–Ω—ã –∏–Ω—Ñ—Ä–∞–∫—Ä–∞—Å–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è")
]

# --- –ù–ê–°–¢–†–û–ô–ö–ò –ò–ì–†–û–í–û–ô –õ–û–ì–ò–ö–ò ---
MAX_PETS = 20
QUIZ_COOLDOWN_HOURS = 5
MARRIAGE_MIN_LEVEL = 35
PET_MIN_LEVEL = 55
MARRIAGE_COST = 250
PET_DEATH_DAYS = 2

PET_ACTIONS_COST = { "feed": 1, "grow": 5, "water": 2, "walk": 3 }

EGGS = {
    "common": {"name": "ü•ö –û–±—ã—á–Ω–æ–µ —è–π—Ü–æ", "cost": 150, "rarity": "common"},
    "rare": {"name": "üíé –†–µ–¥–∫–æ–µ —è–π—Ü–æ", "cost": 500, "rarity": "rare"},
    "legendary": {"name": "‚öúÔ∏è –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ —è–π—Ü–æ", "cost": 1500, "rarity": "legendary"},
    "mythic": {"name": "‚ú® –ú–∏—Ñ–∏—á–µ—Å–∫–æ–µ —è–π—Ü–æ", "cost": 5000, "rarity": "mythic"},
}

PET_SPECIES = {
    "common": [
        {"species_name": "–ü–æ–ª–æ–∑", "images": {1: "https://i.ibb.co/4gRJSF4N/Gemini-Generated-Image-bbrjqrbbrjqrbbrj.png", 10: "https://i.ibb.co/x87LKPq2/image.png", 35: "https://i.ibb.co/ccnTcgJX/image.png"}},
        {"species_name": "–£–∂", "images": {1: "https://i.ibb.co/qLBW0wN7/image.png", 10: "https://i.ibb.co/Z1fRyG8R/image.png", 35: "https://i.ibb.co/Ng6pJ2wm/Gemini-Generated-Image-6z8b4s6z8b4s6z8b.png"}},
    ],
    "rare": [
        {"species_name": "–ì–∞–¥—é–∫–∞", "images": {1: "https://i.ibb.co/xSXPC1C7/image.png", 10: "https://i.ibb.co/Y4KqkSgt/image.png", 35: "https://i.ibb.co/rRhY1nX3/image.png"}},
        {"species_name": "–≠—Ñ–∞", "images": {1: "https://i.ibb.co/TDnDKDJb/image.png", 10: "https://i.ibb.co/XfhfSP31/image.png", 35: "https://i.ibb.co/prvbR5Kf/image.png"}},
    ],
    "legendary": [
        {"species_name": "–ü–∏—Ç–æ–Ω", "images": {1: "https://i.ibb.co/WCXKKBF/image.png", 10: "https://i.ibb.co/j9Q9XZTR/image.png", 35: "https://i.ibb.co/qYjVcqck/Gemini-Generated-Image-aofhgzaofhgzaofh.png"}},
        {"species_name": "–ö–æ–±—Ä–∞", "images": {1: "https://i.ibb.co/DP5QFyJn/Gemini-Generated-Image-gzt9g3gzt9g3gzt9.png", 10: "https://i.ibb.co/HLS6vB21/Gemini-Generated-Image-m2l12m2l12m2l12m.png", 35: "https://i.ibb.co/7xdG7Vmg/Gemini-Generated-Image-pcfv7cpcfv7cpcfv.png"}},
    ],
    "mythic": [
        {"species_name": "–í–∞—Å–∏–ª–∏—Å–∫", "images": {1: "https://i.ibb.co/0Rtx5sb1/Gemini-Generated-Image-rxh7a8rxh7a8rxh7.png", 10: "https://i.ibb.co/RpBs3XxM/Gemini-Generated-Image-togzv2togzv2togz.png", 35: "https://i.ibb.co/FLCVtdVg/Gemini-Generated-Image-bfub33bfub33bfub.png"}},
    ]
}

PING_MESSAGES = [ "—á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è?", "–∑–∞—Ö–æ–¥–∏ –Ω–∞ –∏–≥—Ä—É?", "–∫–∞–∫ –Ω–∞—Å—á–µ—Ç –∫–∞—Ç–∫–∏?", "–≥–æ –æ–±—â–∞—Ç—å—Å—è!", "—Å–∫—É—á–Ω–æ, –¥–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º?"]
recent_users_activity = {}

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
db_pool = None

# --- FSM –°–û–°–¢–û–Ø–ù–ò–Ø ---
class TopupStates(StatesGroup):
    waiting_for_amount = State()

class PetHatchStates(StatesGroup):
    waiting_for_name = State()

class QuizStates(StatesGroup):
    in_quiz = State()

# --- –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• ---
async def create_pool():
    global db_pool
    try:
        db_pool = await asyncpg.create_pool(dsn=DATABASE_URL)
        logger.info("–ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å PostgreSQL —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")
    except Exception as e:
        logger.critical(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL: {e}")
        exit()

async def db_execute(query, *params, fetch=None):
    async with db_pool.acquire() as connection:
        try:
            if fetch == 'one': return await connection.fetchrow(query, *params)
            elif fetch == 'all': return await connection.fetch(query, *params)
            else: await connection.execute(query, *params)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–∞: {query} —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ {params}. –û—à–∏–±–∫–∞: {e}")
            return None

async def init_db():
    await db_execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id BIGINT PRIMARY KEY, username TEXT, balance BIGINT DEFAULT 0,
            level INTEGER DEFAULT 0, last_hunt BIGINT DEFAULT 0, last_quiz BIGINT DEFAULT 0,
            partner_id BIGINT DEFAULT 0, proposal_from_id BIGINT DEFAULT 0,
            prefix_end BIGINT DEFAULT 0, antitar_end BIGINT DEFAULT 0, vip_end BIGINT DEFAULT 0,
            quiz_highscore INTEGER DEFAULT 0
        );
    """)
    try:
        await db_execute("ALTER TABLE users ADD COLUMN IF NOT EXISTS quiz_highscore INTEGER DEFAULT 0;")
    except Exception as e:
        logger.info(f"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É 'quiz_highscore' (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç): {e}")

    await db_execute("""
        CREATE TABLE IF NOT EXISTS pets (
            pet_id SERIAL PRIMARY KEY, owner_id BIGINT NOT NULL, name TEXT,
            species TEXT, pet_level INTEGER DEFAULT 1, last_fed BIGINT DEFAULT 0,
            last_watered BIGINT DEFAULT 0, last_grown BIGINT DEFAULT 0,
            last_walked BIGINT DEFAULT 0, creation_date BIGINT
        );
    """)
    await db_execute("""
        CREATE TABLE IF NOT EXISTS user_eggs (
            user_egg_id SERIAL PRIMARY KEY, owner_id BIGINT, egg_type TEXT
        );
    """)
    await db_execute("""
        CREATE TABLE IF NOT EXISTS quiz_questions (
            question_id SERIAL PRIMARY KEY, question_text TEXT NOT NULL,
            options JSONB NOT NULL, correct_answer TEXT NOT NULL
        );
    """)
    logger.info("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü –≤ –ë–î –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

async def populate_questions():
    async with db_pool.acquire() as connection:
        existing_q_records = await connection.fetch("SELECT question_text FROM quiz_questions")
        existing_q_texts = {rec['question_text'] for rec in existing_q_records}
        questions_to_add = [q for q in QUIZ_QUESTIONS if q[0] not in existing_q_texts]
        if questions_to_add:
            await connection.executemany(
                "INSERT INTO quiz_questions (question_text, options, correct_answer) VALUES ($1, $2, $3)",
                questions_to_add
            )
            logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–æ {len(questions_to_add)} –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.")

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ ---
async def get_user(user_id: int):
    return await db_execute("SELECT * FROM users WHERE user_id = $1", user_id, fetch='one')

async def add_user(user_id: int, username: str):
    await db_execute("INSERT INTO users (user_id, username) VALUES ($1, $2) ON CONFLICT (user_id) DO NOTHING", user_id, username)

async def update_user_field(user_id: int, field: str, value):
    await db_execute(f"UPDATE users SET {field} = $1 WHERE user_id = $2", value, user_id)

async def get_pet(owner_id: int):
    return await db_execute("SELECT * FROM pets WHERE owner_id = $1 LIMIT 1", owner_id, fetch='one')

async def create_pet(owner_id: int, name: str, species: str):
    now = int(datetime.now().timestamp())
    await db_execute("INSERT INTO pets (owner_id, name, species, last_fed, last_watered, last_grown, last_walked, creation_date) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)", owner_id, name, species, now, now, now, now, now)

async def delete_pet(owner_id: int):
    await db_execute("DELETE FROM pets WHERE owner_id = $1", owner_id)

async def get_user_eggs(owner_id: int):
    return await db_execute("SELECT * FROM user_eggs WHERE owner_id = $1", owner_id, fetch='all')

async def add_user_egg(owner_id: int, egg_type: str):
    await db_execute("INSERT INTO user_eggs (owner_id, egg_type) VALUES ($1, $2)", owner_id, egg_type)

async def delete_user_egg(user_egg_id: int):
    await db_execute("DELETE FROM user_eggs WHERE user_egg_id = $1", user_egg_id)

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
async def get_user_mention_by_id(user_id: int) -> str:
    try:
        user = await bot.get_chat(user_id)
        return f'<a href="tg://user?id={user.id}">{user.full_name}</a>'
    except TelegramBadRequest:
        return f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (ID: {user_id})"
    except Exception as e:
        logger.error(f"Could not get user mention for {user_id}: {e}")
        return f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (ID: {user_id})"

async def check_items(user_id: int):
    user = await get_user(user_id)
    if not user: return
    now = int(datetime.now().timestamp())
    updates = {}
    if user.get("prefix_end") and user["prefix_end"] < now: updates["prefix_end"] = 0
    if user.get("antitar_end") and user["antitar_end"] < now: updates["antitar_end"] = 0
    if user.get("vip_end") and user["vip_end"] < now: updates["vip_end"] = 0
    for field, value in updates.items(): await update_user_field(user_id, field, value)

async def check_pet_death(owner_id: int):
    pet = await get_pet(owner_id)
    if not pet:
        return True
    now_ts = int(datetime.now().timestamp())
    death_timestamp = now_ts - (PET_DEATH_DAYS * 24 * 3600)
    last_action_time = max(pet.get('last_fed', 0), pet.get('last_watered', 0), pet.get('last_walked', 0))
    if last_action_time > death_timestamp:
        return True
    await delete_pet(owner_id)
    try:
        await bot.send_message(owner_id, f"üíî –í–∞—à –ø–∏—Ç–æ–º–µ—Ü {pet['name']} ({pet['species']}) —É–º–µ—Ä –æ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —É—Ö–æ–¥–∞...")
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–º–µ—Ä—Ç–∏ –ø–∏—Ç–æ–º—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {owner_id}: {e}")
    return False

async def notify_admins_of_purchase(user_id: int, item_name: str, days: int, new_balance: int, new_end_timestamp: int):
    try:
        user_mention = await get_user_mention_by_id(user_id)
        purchase_time = datetime.now().strftime('%d.%m.%Y %H:%M:%S')
        end_time = datetime.fromtimestamp(new_end_timestamp).strftime('%d.%m.%Y %H:%M:%S')
        text = (
            f"üõí <b>–ù–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞!</b>\n\n"
            f"üë§ <b>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</b> {user_mention} (ID: <code>{user_id}</code>)\n"
            f"üõçÔ∏è <b>–¢–æ–≤–∞—Ä:</b> {item_name}\n"
            f"‚è≥ <b>–°—Ä–æ–∫:</b> {days} –¥–Ω.\n"
            f"ü¶é <b>–û—Å—Ç–∞—Ç–æ–∫ –±–∞–ª–∞–Ω—Å–∞:</b> {new_balance}\n\n"
            f"üïí <b>–í—Ä–µ–º—è –ø–æ–∫—É–ø–∫–∏:</b> {purchase_time}\n"
            f"üîö <b>–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:</b> {end_time}"
        )
        target_group_id = -1001863605735
        notification_chat_ids = set(ADMIN_IDS)
        notification_chat_ids.add(target_group_id)
        for chat_id in notification_chat_ids:
            try:
                await bot.send_message(chat_id, text, parse_mode=ParseMode.HTML)
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ –≤ —á–∞—Ç {chat_id}: {e}")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–∫—É–ø–∫–µ: {e}")

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ---
@dp.message(or_f(Command("start", "help", "—Å—Ç–∞—Ä—Ç", "–ø–æ–º–æ—â—å"), F.text.lower().in_(['start', 'help', '—Å—Ç–∞—Ä—Ç', '–ø–æ–º–æ—â—å'])))
async def cmd_start(message: Message):
    try:
        user_id = message.from_user.id
        username = message.from_user.username or message.from_user.full_name
        await add_user(user_id, username)
        if message.chat.type == 'private':
            tutorial_text = (
                "üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤ –∑–º–µ–∏–Ω–æ–º –±–æ—Ç–µ!\n\n"
                "**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n"
                "‚ñ´Ô∏è `/profile` –∏–ª–∏ `–ø—Ä–æ—Ñ–∏–ª—å` ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\n"
                "‚ñ´Ô∏è `/hunt` –∏–ª–∏ `–æ—Ö–æ—Ç–∞` ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –Ω–∞ –æ—Ö–æ—Ç—É.\n"
                "‚ñ´Ô∏è `/pay` –∏–ª–∏ `–ø–µ—Ä–µ–≤–æ–¥` (–≤ –æ—Ç–≤–µ—Ç) ‚Äî –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —è—â–µ—Ä–æ–∫.\n"
                "‚ñ´Ô∏è `/shop` –∏–ª–∏ `–º–∞–≥–∞–∑–∏–Ω` ‚Äî –∫—É–ø–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏—è.\n"
                "‚ñ´Ô∏è `/topup` –∏–ª–∏ `–ø–æ–ø–æ–ª–Ω–∏—Ç—å` ‚Äî –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –∑–∞ Telegram ‚òÖ.\n\n"
                "**–ò–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏:**\n"
                "üêç `/quiz` –∏–ª–∏ `–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞` - –ø—Ä–æ–π—Ç–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É.\n"
                "üíñ `/marry` –∏–ª–∏ `–∂–µ–Ω–∏—Ç—å` (–≤ –æ—Ç–≤–µ—Ç) - —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.\n"
                "ü•ö `/eggshop` –∏–ª–∏ `–º–∞–≥–∞–∑–∏–Ω—è–∏—Ü` - –º–∞–≥–∞–∑–∏–Ω —è–∏—Ü.\n"
                "üß∫ `/myeggs` –∏–ª–∏ `–º–æ–∏—è–π—Ü–∞` - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —è–π—Ü–∞.\n"
                "üêæ `/mypet` –∏–ª–∏ `–º–æ–π–ø–∏—Ç–æ–º–µ—Ü` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–µ–º.\n"
                "üìû `/ping` –∏–ª–∏ `–ø–∏–Ω–≥` - –ø–æ–∑–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –≤ —á–∞—Ç–µ.\n\n"
                "**–ö–æ–º–∞–Ω–¥—ã –æ—Ç–Ω–æ—à–µ–Ω–∏–π:**\n"
                "üíç `/accept` –∏–ª–∏ `–ø—Ä–∏–Ω—è—Ç—å` - –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.\n"
                "üíî `/divorce` –∏–ª–∏ `—Ä–∞–∑–≤–æ–¥` - —Ä–∞–∑–æ—Ä–≤–∞—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è."
            )
            await message.answer(tutorial_text, parse_mode=None)
        else:
            await message.answer("üêç –ó–º–µ–∏–Ω—ã–π –±–æ—Ç –∫ –≤–∞—à–∏–º —É—Å–ª—É–≥–∞–º! –ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥, –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.")
    except Exception as e:
        logger.exception(f"Error in start command: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

@dp.message(or_f(Command("profile", "–ø—Ä–æ—Ñ–∏–ª—å"), F.text.lower().in_(['profile', '–ø—Ä–æ—Ñ–∏–ª—å'])))
async def cmd_profile(message: Message):
    try:
        target_user_msg = message.reply_to_message or message
        user_id = target_user_msg.from_user.id
        username = target_user_msg.from_user.username or target_user_msg.from_user.full_name
        await add_user(user_id, username)
        user = await get_user(user_id)
        if not user:
            await message.answer("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å.")
            return

        await check_items(user_id)
        user = await get_user(user_id)

        balance = user.get("balance", 0)
        level = user.get("level", 0)
        partner_id = user.get("partner_id")
        prefix_end = user.get("prefix_end")
        antitar_end = user.get("antitar_end")
        vip_end = user.get("vip_end")
        highscore = user.get("quiz_highscore", 0)

        now = int(datetime.now().timestamp())
        def format_item(end_timestamp):
            if end_timestamp and end_timestamp > now:
                dt = datetime.fromtimestamp(end_timestamp)
                return f"–∞–∫—Ç–∏–≤–µ–Ω –¥–æ {dt.strftime('%d.%m.%Y %H:%M')}"
            return "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

        partner_status = "–≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ"
        if partner_id:
            partner_name = await get_user_mention_by_id(partner_id)
            partner_status = f"–≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å {partner_name}"

        profile_title = "üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å" if user_id == message.from_user.id else f"üë§ –ü—Ä–æ—Ñ–∏–ª—å {target_user_msg.from_user.full_name}"

        text = (
            f"{profile_title}:\n"
            f"–£—Ä–æ–≤–µ–Ω—å: {level} üêç\n"
            f"–ë–∞–ª–∞–Ω—Å: {balance} ü¶é\n"
            f"–†–µ–∫–æ—Ä–¥ –≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ: {highscore} üß†\n"
            f"–°—Ç–∞—Ç—É—Å: {partner_status}\n\n"
            f"–ü—Ä–µ—Ñ–∏–∫—Å: {format_item(prefix_end)}\n"
            f"–ê–Ω—Ç–∏—Ç–∞—Ä: {format_item(antitar_end)}\n"
            f"VIP: {format_item(vip_end)}"
        )

        kb = InlineKeyboardBuilder()
        kb.add(types.InlineKeyboardButton(text="üêç –ü—Ä–æ–π—Ç–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É", callback_data="start_quiz"))
        kb.add(types.InlineKeyboardButton(text="üêæ –ú–æ–π –ø–∏—Ç–æ–º–µ—Ü", callback_data="my_pet_profile"))
        kb.add(types.InlineKeyboardButton(text="üõí –ú–∞–≥–∞–∑–∏–Ω", callback_data="shop_main"))
        kb.adjust(1)
        await message.answer(text, reply_markup=kb.as_markup())
    except Exception as e:
        logger.exception(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /profile: {e}")
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.")

@dp.message(or_f(Command("hunt", "–æ—Ö–æ—Ç–∞"), F.text.lower().in_(['hunt', '–æ—Ö–æ—Ç–∞'])))
async def cmd_hunt(message: Message):
    user_id = message.from_user.id
    await add_user(user_id, message.from_user.username or message.from_user.full_name)
    user = await get_user(user_id)
    now = int(datetime.now().timestamp())
    last_hunt = user.get("last_hunt", 0)
    cooldown = 24 * 3600 
    if now - last_hunt < cooldown:
        remaining = cooldown - (now - last_hunt)
        hours, remainder = divmod(remaining, 3600)
        minutes, _ = divmod(remainder, 60)
        await message.answer(f"‚è≥ –û—Ö–æ—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ {int(hours)} —á {int(minutes)} –º–∏–Ω.")
        return
    catch = random.randint(1, 10)
    current_balance = user.get("balance", 0)
    new_balance = current_balance + catch
    await update_user_field(user_id, "balance", new_balance)
    await update_user_field(user_id, "last_hunt", now)
    await message.answer(f"üéâ –í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å –Ω–∞ –æ—Ö–æ—Ç—É –∏ –ø–æ–π–º–∞–ª–∏ {catch} ü¶é!\n–í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {new_balance} ü¶é")

@dp.message(or_f(Command("pay", "–ø–µ—Ä–µ–≤–æ–¥"), F.text.lower().startswith(('pay ', '–ø–µ—Ä–µ–≤–æ–¥ '))))
async def cmd_pay(message: Message, command: CommandObject = None):
    if message.chat.type == 'private':
        await message.answer("–≠—Ç—É –∫–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø–µ, –æ—Ç–≤–µ—á–∞—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return
    if not message.reply_to_message or message.reply_to_message.from_user.is_bot or message.reply_to_message.from_user.id == message.from_user.id:
        await message.reply("‚ùóÔ∏è **–û—à–∏–±–∫–∞:**\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return
    args = None
    if command:
        args = command.args
    else:
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
    if args is None:
        await message.reply("‚ùóÔ∏è **–û—à–∏–±–∫–∞:**\n–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞. –ü—Ä–∏–º–µ—Ä: `–ø–µ—Ä–µ–≤–æ–¥ 50`")
        return
    try:
        amount = int(args)
        if amount <= 0: raise ValueError
    except (TypeError, ValueError):
        await message.reply("‚ùóÔ∏è **–û—à–∏–±–∫–∞:**\n–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã. –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ. –ü—Ä–∏–º–µ—Ä: `–ø–µ—Ä–µ–≤–æ–¥ 50`")
        return
    sender = message.from_user
    recipient = message.reply_to_message.from_user
    await add_user(sender.id, sender.username or sender.full_name)
    await add_user(recipient.id, recipient.username or recipient.full_name)
    sender_data = await get_user(sender.id)
    sender_balance = sender_data.get('balance', 0)
    if sender_balance < amount:
        await message.reply(f"‚ùå **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!**\n–£ –≤–∞—Å –Ω–∞ –±–∞–ª–∞–Ω—Å–µ –≤—Å–µ–≥–æ {sender_balance} ü¶é.")
        return
    recipient_data = await get_user(recipient.id)
    recipient_balance = recipient_data.get('balance', 0)
    await update_user_field(sender.id, "balance", sender_balance - amount)
    await update_user_field(recipient.id, "balance", recipient_balance + amount)
    sender_mention = await get_user_mention_by_id(sender.id)
    recipient_mention = await get_user_mention_by_id(recipient.id)
    await message.answer(f"üí∏ **–ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–µ–Ω!**\n\n{sender_mention} –ø–µ—Ä–µ–≤–µ–ª(–∞) {amount} ü¶é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {recipient_mention}.")

# --- –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–´ ---
# ... (–≤—Å–µ –∞–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

# =========================================================================
# ================= –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –í–ò–ö–¢–û–†–ò–ù–´ ================================
# =========================================================================

async def end_quiz(state: FSMContext, message: Message, reason: str):
    user_id = message.chat.id
    data = await state.get_data()
    score = data.get('score', 0)
    timer_task = data.get('timer_task')
    if timer_task:
        timer_task.cancel()
    user_data = await get_user(user_id)
    highscore = user_data.get('quiz_highscore', 0) if user_data else 0
    final_text = f"üêç –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! {reason}\n\n"
    final_text += f"üß† –í–∞—à —Å—á—ë—Ç: {score}\n"
    if score > highscore:
        final_text += f"üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! (–ü—Ä–µ–∂–Ω–∏–π: {highscore})"
        await update_user_field(user_id, 'quiz_highscore', score)
    else:
        final_text += f"üèÜ –í–∞—à —Ä–µ–∫–æ—Ä–¥: {highscore}"
    cooldown_timestamp = int(datetime.now().timestamp())
    await update_user_field(user_id, 'last_quiz', cooldown_timestamp)
    await message.answer(final_text)
    await state.clear()

async def send_question(state: FSMContext, message: Message):
    data = await state.get_data()
    q_index = data.get('current_question_index', 0)
    q_ids = data.get('question_ids', [])
    score = data.get('score', 0)
    if q_index >= len(q_ids):
        await end_quiz(state, message, reason="–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!")
        return
    question_id = q_ids[q_index]
    q_data = await db_execute("SELECT * FROM quiz_questions WHERE question_id = $1", question_id, fetch='one')
    if not q_data:
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –≤–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
        await state.clear()
        return
    await state.update_data(correct_answer=q_data['correct_answer'])
    options = json.loads(q_data['options'])
    random.shuffle(options)
    kb = InlineKeyboardBuilder()
    for option in options:
        kb.add(types.InlineKeyboardButton(text=option, callback_data=f"quiz_answer:{option}"))
    kb.adjust(1)
    question_text = (
        f"<b>–í–æ–ø—Ä–æ—Å {q_index + 1} –∏–∑ {len(q_ids)}</b> (–°—á—ë—Ç: {score})\n\n"
        f"{q_data['question_text']}"
    )
    msg = await message.answer(question_text, reply_markup=kb.as_markup())
    timer_task = asyncio.create_task(question_timer(state, msg, 60))
    await state.update_data(question_message_id=msg.message_id, timer_task=timer_task)

async def question_timer(state: FSMContext, message: Message, seconds: int):
    await asyncio.sleep(seconds)
    if await state.get_state() == QuizStates.in_quiz:
        data = await state.get_data()
        if data.get('question_message_id') == message.message_id:
            try:
                await message.delete()
            except TelegramBadRequest:
                pass
            await end_quiz(state, message, reason="–í—Ä–µ–º—è –≤—ã—à–ª–æ!")

@dp.message(or_f(Command("quiz", "–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞"), F.text.lower() == '–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞'))
@dp.callback_query(F.data == "start_quiz")
async def cmd_start_quiz(event: Message | CallbackQuery, state: FSMContext):
    user_id = event.from_user.id
    user = await get_user(user_id)
    if not user:
        await add_user(user_id, event.from_user.username or event.from_user.full_name)
        user = await get_user(user_id)
    now = int(datetime.now().timestamp())
    cooldown_end_time = (user.get('last_quiz', 0) or 0) + (QUIZ_COOLDOWN_HOURS * 3600)
    if now < cooldown_end_time:
        remaining = cooldown_end_time - now
        hours, remainder = divmod(remaining, 3600)
        minutes, _ = divmod(remainder, 60)
        text = f"‚è≥ –°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ {int(hours)} —á {int(minutes)} –º–∏–Ω."
        if isinstance(event, CallbackQuery):
            await event.answer(text, show_alert=True)
        else:
            await event.answer(text)
        return
    all_q_records = await db_execute("SELECT question_id FROM quiz_questions", fetch='all')
    if not all_q_records:
        text = "–í –±–∞–∑–µ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã. –ó–∞–π–¥–∏—Ç–µ –ø–æ–∑–∂–µ!"
        if isinstance(event, CallbackQuery):
            await event.answer(text, show_alert=True)
        else:
            await event.answer(text)
        return
    question_ids = [rec['question_id'] for rec in all_q_records]
    random.shuffle(question_ids)
    await state.set_state(QuizStates.in_quiz)
    await state.update_data(score=0, current_question_index=0, question_ids=question_ids, timer_task=None)
    message = event if isinstance(event, Message) else event.message
    await message.answer("üêç –ù–∞—á–∏–Ω–∞–µ–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—É! –£ –≤–∞—Å –µ—Å—Ç—å 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç. –û—à–∏–±–∫–∞ = –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã.")
    await send_question(state, message)
    if isinstance(event, CallbackQuery):
        await event.answer()

# –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î
@dp.callback_query(QuizStates.in_quiz, F.data.startswith("quiz_answer:"))
async def cb_process_quiz_answer(callback: CallbackQuery, state: FSMContext):
    user_answer = callback.data.split(":", 1)[1]
    quiz_data = await state.get_data()
    correct_answer = quiz_data.get('correct_answer')
    
    if not correct_answer:
        await callback.answer()
        return

    user = await get_user(callback.from_user.id)
    current_level = user['level'] or 0

    if user_answer == correct_answer:
        new_level = current_level + 1
        result_text = f"‚úÖ <b>–ü—Ä–∞–≤–∏–ª—å–Ω–æ!</b>\n\n–í–∞—à —É—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω: {current_level} ‚û°Ô∏è {new_level}"
    else:
        new_level = max(0, current_level - 1)
        result_text = f"‚ùå <b>–ù–µ–≤–µ—Ä–Ω–æ!</b> –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_answer}\n\n–í–∞—à —É—Ä–æ–≤–µ–Ω—å –ø–æ–Ω–∏–∂–µ–Ω: {current_level} ‚û°Ô∏è {new_level}"

    await update_user_field(callback.from_user.id, 'level', new_level)
    await update_user_field(callback.from_user.id, 'last_quiz', int(datetime.now().timestamp()))
    await state.clear()
    
    await callback.message.edit_text(result_text, reply_markup=None)
    await callback.answer()



# --- –°–ò–°–¢–ï–ú–ê –ü–ò–¢–û–ú–¶–ï–í ---
@dp.message(or_f(Command("eggshop", "–º–∞–≥–∞–∑–∏–Ω—è–∏—Ü"), F.text.lower().in_(['eggshop', '–º–∞–≥–∞–∑–∏–Ω—è–∏—Ü'])))
async def cmd_eggshop(message: Message):
    text = "ü•ö **–ú–∞–≥–∞–∑–∏–Ω —è–∏—Ü** ü•ö\n\n–í—ã–±–µ—Ä–∏—Ç–µ —è–π—Ü–æ, —á—Ç–æ–±—ã –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –µ–≥–æ:"
    kb = InlineKeyboardBuilder()
    for egg_type, data in EGGS.items():
        kb.add(types.InlineKeyboardButton(text=f"{data['name']} ({data['cost']} ü¶é)", callback_data=f"buy_egg:{egg_type}"))
    kb.adjust(1)
    await message.answer(text, reply_markup=kb.as_markup())

@dp.callback_query(F.data.startswith("buy_egg:"))
async def cb_buy_egg(callback: CallbackQuery):
    egg_type = callback.data.split(":")[1]
    egg_data = EGGS.get(egg_type)
    if not egg_data: return await callback.answer("–¢–∞–∫–æ–µ —è–π—Ü–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!", show_alert=True)
    
    user_id = callback.from_user.id
    user = await get_user(user_id)
    user_balance = user['balance'] or 0
    
    if user_balance < egg_data['cost']:
        return await callback.answer(f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –ù—É–∂–Ω–æ {egg_data['cost']} ü¶é.", show_alert=True)
    
    await update_user_field(user_id, 'balance', user_balance - egg_data['cost'])
    await add_user_egg(user_id, egg_type)
    
    await callback.answer(f"–í—ã —É—Å–ø–µ—à–Ω–æ –∫—É–ø–∏–ª–∏ {egg_data['name']}!", show_alert=True)
    await callback.message.answer(f"üéâ –í—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏ {egg_data['name']}! –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —è–π—Ü–∞ –∏ –≤—ã–ª—É–ø–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞ –º–æ–∂–Ω–æ –ø–æ –∫–æ–º–∞–Ω–¥–µ /myeggs –∏–ª–∏ –º–æ–∏—è–π—Ü–∞.")

@dp.message(or_f(Command("myeggs", "–º–æ–∏—è–π—Ü–∞"), F.text.lower().in_(['myeggs', '–º–æ–∏—è–π—Ü–∞'])))
async def cmd_myeggs(message: Message):
    user_id = message.from_user.id
    user_eggs = await get_user_eggs(user_id)
    
    if not user_eggs:
        return await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —è–∏—Ü. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤ /eggshop –∏–ª–∏ –º–∞–≥–∞–∑–∏–Ω —è–∏—Ü!")
        
    text = "üß∫ **–í–∞—à–∏ —è–π—Ü–∞** üß∫\n\n–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –≤—ã–ª—É–ø–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞:"
    kb = InlineKeyboardBuilder()
    for egg in user_eggs:
        egg_data = EGGS.get(egg['egg_type'])
        if egg_data:
            kb.add(types.InlineKeyboardButton(text=f"–í—ã–ª—É–ø–∏—Ç—å {egg_data['name']}", callback_data=f"hatch_egg:{egg['user_egg_id']}"))
    kb.adjust(1)
    await message.answer(text, reply_markup=kb.as_markup())
    
@dp.callback_query(F.data.startswith("hatch_egg:"))
async def cb_hatch_egg(callback: CallbackQuery, state: FSMContext):
    user_egg_id = int(callback.data.split(":")[1])
    user_id = callback.from_user.id
    
    user = await get_user(user_id)
    if (user['level'] or 0) < PET_MIN_LEVEL:
        return await callback.answer(f"–í—ã–ª—É–ø–ª—è—Ç—å –ø–∏—Ç–æ–º—Ü–µ–≤ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å {PET_MIN_LEVEL} —É—Ä–æ–≤–Ω—è!", show_alert=True)
        
    pet = await get_pet(user_id)
    if pet:
        return await callback.answer("–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–∏—Ç–æ–º–µ—Ü! –ù–µ–ª—å–∑—è –∑–∞–≤–µ—Å—Ç–∏ –≤—Ç–æ—Ä–æ–≥–æ.", show_alert=True)
        
    user_eggs = await get_user_eggs(user_id)
    target_egg = next((e for e in user_eggs if e['user_egg_id'] == user_egg_id), None)
    
    if not target_egg:
        await callback.message.edit_text("–≠—Ç–æ–≥–æ —è–π—Ü–∞ —É –≤–∞—Å –±–æ–ª—å—à–µ –Ω–µ—Ç.")
        return await callback.answer()
        
    await state.set_state(PetHatchStates.waiting_for_name)
    await state.update_data(user_egg_id=user_egg_id, egg_type=target_egg['egg_type'])
    
    await callback.message.edit_text("–û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫ –≤—ã –Ω–∞–∑–æ–≤–µ—Ç–µ —Å–≤–æ–µ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–∏—Ç–æ–º—Ü–∞? –í–≤–µ–¥–∏—Ç–µ –∏–º—è (–¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤).")
    await callback.answer()

@dp.message(PetHatchStates.waiting_for_name)
async def process_pet_name_after_hatch(message: Message, state: FSMContext):
    pet_name = message.text
    if len(pet_name) > 15:
        return await message.answer("–ò–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ (–¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤).")

    hatch_data = await state.get_data()
    user_egg_id = hatch_data['user_egg_id']
    egg_type = hatch_data['egg_type']
    
    egg_rarity = EGGS[egg_type]['rarity']
    possible_species = PET_SPECIES[egg_rarity]
    hatched_species_data = random.choice(possible_species)
    hatched_species_name = hatched_species_data['species_name']
    
    await delete_user_egg(user_egg_id)
    await create_pet(message.from_user.id, pet_name, hatched_species_name)
    await state.clear()
    
    await message.answer(f"üéâ –ò–∑ —è–π—Ü–∞ –≤—ã–ª—É–ø–∏–ª—Å—è **{hatched_species_name}**!\n–í—ã –Ω–∞–∑–≤–∞–ª–∏ –µ–≥–æ **{pet_name}**.\n\n–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ó–∞–±–æ—Ç—å—Ç–µ—Å—å –æ –Ω–µ–º —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /mypet –∏–ª–∏ –º–æ–π–ø–∏—Ç–æ–º–µ—Ü.")

@dp.message(or_f(Command("mypet", "–º–æ–π–ø–∏—Ç–æ–º–µ—Ü"), F.text.lower().in_(['mypet', '–º–æ–π–ø–∏—Ç–æ–º–µ—Ü'])))
async def cmd_mypet(message: Message):
    await my_pet_profile_logic(message.from_user.id, message)

@dp.callback_query(F.data == "my_pet_profile")
async def cb_mypet(callback: CallbackQuery):
    await my_pet_profile_logic(callback.from_user.id, callback, is_callback=True)

async def my_pet_profile_logic(user_id: int, event: Message | CallbackQuery, is_callback: bool = False):
    if is_callback:
        await event.answer()
    
    message = event if not is_callback else event.message
        
    if not await check_pet_death(user_id):
        if is_callback:
            try: await message.delete()
            except: pass
        return

    pet = await get_pet(user_id)
    if not pet:
        kb = InlineKeyboardBuilder().add(types.InlineKeyboardButton(text="ü•ö –í –º–∞–≥–∞–∑–∏–Ω —è–∏—Ü", callback_data="go_to_eggshop"))
        text = "–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–∞. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω —è–∏—Ü, —á—Ç–æ–±—ã –∑–∞–≤–µ—Å—Ç–∏ —Å–≤–æ–µ–≥–æ!"
        if is_callback and hasattr(message, 'photo') and message.photo:
            await message.delete()
            await message.answer(text, reply_markup=kb.as_markup())
        elif is_callback:
            await message.edit_text(text, reply_markup=kb.as_markup())
        else:
            await message.answer(text, reply_markup=kb.as_markup())
        return

    now_ts = int(datetime.now().timestamp())
    pet_level = pet['pet_level']
    pet_species = pet['species']
    
    def format_time_since(timestamp):
        if not timestamp: return "–Ω–∏–∫–æ–≥–¥–∞"
        dt_obj = datetime.fromtimestamp(timestamp)
        return dt_obj.strftime('%d.%m %H:%M')

    caption = (
        f"üêæ **–ü–∏—Ç–æ–º–µ—Ü: {pet['name']}** ({pet_species})\n\n"
        f"–£—Ä–æ–≤–µ–Ω—å: {pet_level}\n"
        f"–ö–æ—Ä–º: {format_time_since(pet['last_fed'])}\n"
    )
    if pet_level >= 10:
        caption += f"–í–æ–¥–∞: {format_time_since(pet['last_watered'])}\n"
    if pet_level >= 15:
        caption += f"–ü—Ä–æ–≥—É–ª–∫–∞: {format_time_since(pet['last_walked'])}\n"

    kb = InlineKeyboardBuilder()
    kb.add(types.InlineKeyboardButton(text=f"–ü–æ–∫–æ—Ä–º–∏—Ç—å ({PET_ACTIONS_COST['feed']}ü¶é)", callback_data="pet_action:feed"))
    
    grow_cooldown_ok = now_ts - (pet['last_grown'] or 0) > 24 * 3600
    grow_btn_text = f"–†–∞—Å—Ç–∏—Ç—å ({PET_ACTIONS_COST['grow']}ü¶é)" if grow_cooldown_ok else "–†–∞—Å—Ç–∏—Ç—å (–ö–î)"
    kb.add(types.InlineKeyboardButton(text=grow_btn_text, callback_data="pet_action:grow"))

    if pet_level >= 10:
        kb.add(types.InlineKeyboardButton(text=f"–ü–æ–∏—Ç—å ({PET_ACTIONS_COST['water']}ü¶é)", callback_data="pet_action:water"))
    if pet_level >= 15:
        kb.add(types.InlineKeyboardButton(text=f"–í—ã–≥—É–ª–∏–≤–∞—Ç—å ({PET_ACTIONS_COST['walk']}ü¶é)", callback_data="pet_action:walk"))
    
    kb.adjust(2)

    image_url = "https://i.imgur.com/3TSa7A0.png"
    species_data = next((s for rarity in PET_SPECIES.values() for s in rarity if s['species_name'] == pet_species), None)
    if species_data:
        for level_threshold, url in sorted(species_data['images'].items(), reverse=True):
            if pet_level >= level_threshold:
                image_url = url
                break
    
    try:
        if is_callback:
            media = types.InputMediaPhoto(media=image_url, caption=caption)
            await message.edit_media(media=media, reply_markup=kb.as_markup())
        else:
            await bot.send_photo(user_id, photo=image_url, caption=caption, reply_markup=kb.as_markup())
    except TelegramBadRequest as e:
        if "message is not modified" in str(e):
            if is_callback: await event.answer("–î–∞–Ω–Ω—ã–µ –ø–∏—Ç–æ–º—Ü–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.")
        else:
            logger.error(f"Failed to edit pet profile, sending new: {e}")
            await bot.send_photo(user_id, photo=image_url, caption=caption, reply_markup=kb.as_markup())

@dp.callback_query(F.data == "go_to_eggshop")
async def cb_go_to_eggshop(callback: CallbackQuery):
    await callback.message.delete()
    await cmd_eggshop(callback.message)
    await callback.answer()

async def notify_admins_of_purchase(user_id: int, item_name: str, days: int, new_balance: int, new_end_timestamp: int):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ –∞–¥–º–∏–Ω–∞–º –∏ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É."""
    try:
        # 1. –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
        user_mention = await get_user_mention_by_id(user_id)
        purchase_time = datetime.now().strftime('%d.%m.%Y %H:%M:%S')
        end_time = datetime.fromtimestamp(new_end_timestamp).strftime('%d.%m.%Y %H:%M:%S')

        # 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        text = (
            f"üõí <b>–ù–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞!</b>\n\n"
            f"üë§ <b>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</b> {user_mention} (ID: <code>{user_id}</code>)\n"
            f"üõçÔ∏è <b>–¢–æ–≤–∞—Ä:</b> {item_name}\n"
            f"‚è≥ <b>–°—Ä–æ–∫:</b> {days} –¥–Ω.\n"
            f"ü¶é <b>–û—Å—Ç–∞—Ç–æ–∫ –±–∞–ª–∞–Ω—Å–∞:</b> {new_balance}\n\n"
            f"üïí <b>–í—Ä–µ–º—è –ø–æ–∫—É–ø–∫–∏:</b> {purchase_time}\n"
            f"üîö <b>–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:</b> {end_time}"
        )

        # 3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        target_group_id = -1001863605735
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º set, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —á–∞—Ç
        notification_chat_ids = set(ADMIN_IDS)
        notification_chat_ids.add(target_group_id)

        # 4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º
        for chat_id in notification_chat_ids:
            try:
                await bot.send_message(chat_id, text)
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ –≤ —á–∞—Ç {chat_id}: {e}")

    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–∫—É–ø–∫–µ: {e}")


@dp.callback_query(F.data.startswith("pet_action:"))
async def cb_pet_action(callback: CallbackQuery):
    action = callback.data.split(":")[1]
    user_id = callback.from_user.id
    
    if not await check_pet_death(user_id):
        try: await callback.message.delete()
        except: pass
        await callback.answer("–í–∞—à –ø–∏—Ç–æ–º–µ—Ü —É–º–µ—Ä...", show_alert=True)
        return

    pet = await get_pet(user_id)
    user = await get_user(user_id)
    cost = PET_ACTIONS_COST.get(action, 0)
    
    user_balance = user['balance'] or 0
    if user_balance < cost:
        await callback.answer(f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —è—â–µ—Ä–æ–∫! –ù—É–∂–Ω–æ {cost} ü¶é.", show_alert=True)
        return

    now = int(datetime.now().timestamp())
    
    result_text = ""
    if action == "grow":
        if now - (pet['last_grown'] or 0) < 24 * 3600:
            await callback.answer("–†–∞—Å—Ç–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –¥–µ–Ω—å!", show_alert=True)
            return
        await db_execute("UPDATE pets SET pet_level = $1, last_grown = $2 WHERE owner_id = $3", pet['pet_level'] + 1, now, user_id)
        result_text = f"–í—ã –≤—ã—Ä–∞—Å—Ç–∏–ª–∏ —Å–≤–æ–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞! –ï–≥–æ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: {pet['pet_level'] + 1}."
    elif action == "feed":
        await update_pet_field(user_id, "last_fed", now)
        result_text = "–í—ã –ø–æ–∫–æ—Ä–º–∏–ª–∏ –ø–∏—Ç–æ–º—Ü–∞."
    elif action == "water":
        if pet['pet_level'] < 10:
            await callback.answer("–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Å 10 —É—Ä–æ–≤–Ω—è –ø–∏—Ç–æ–º—Ü–∞!", show_alert=True)
            return
        await update_pet_field(user_id, "last_watered", now)
        result_text = "–í—ã –Ω–∞–ø–æ–∏–ª–∏ –ø–∏—Ç–æ–º—Ü–∞."
    elif action == "walk":
        if pet['pet_level'] < 15:
            await callback.answer("–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Å 15 —É—Ä–æ–≤–Ω—è –ø–∏—Ç–æ–º—Ü–∞!", show_alert=True)
            return
        await update_pet_field(user_id, "last_walked", now)
        result_text = "–í—ã –≤—ã–≥—É–ª—è–ª–∏ –ø–∏—Ç–æ–º—Ü–∞."
    else:
        return

    await update_user_field(user_id, "balance", user_balance - cost)
    await callback.answer(result_text, show_alert=False)
    await my_pet_profile_logic(user_id, callback, is_callback=True)

# --- –°–ò–°–¢–ï–ú–ê –ú–ê–ì–ê–ó–ò–ù–ê ---
SHOP_ITEMS = {"prefix": {"name": "–ü—Ä–µ—Ñ–∏–∫—Å", "prices": {1: 20, 3: 40, 7: 100}}, "antitar": {"name": "–ê–Ω—Ç–∏—Ç–∞—Ä", "prices": {1: 30, 3: 60, 7: 130}}, "vip": {"name": "VIP", "prices": {1: 50, 3: 100, 7: 300}}}

def create_shop_menu():
    kb = InlineKeyboardBuilder()
    for item_id, item_data in SHOP_ITEMS.items():
        kb.add(types.InlineKeyboardButton(text=item_data["name"], callback_data=f"shop_item:{item_id}"))
    kb.adjust(1)
    return kb.as_markup()

def create_item_menu(item_id: str):
    kb = InlineKeyboardBuilder()
    item_data = SHOP_ITEMS[item_id]
    for days, price in item_data["prices"].items():
        kb.add(types.InlineKeyboardButton(text=f"{days} –¥–Ω. - {price} ü¶é", callback_data=f"buy:{item_id}:{days}"))
    kb.add(types.InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="shop_main"))
    kb.adjust(1)
    return kb.as_markup()

@dp.message(or_f(Command("shop", "–º–∞–≥–∞–∑–∏–Ω"), F.text.lower().in_(['shop', '–º–∞–≥–∞–∑–∏–Ω'])))
async def cmd_shop(message: Message):
    await message.answer("üõí –ú–∞–≥–∞–∑–∏–Ω: –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏.", reply_markup=create_shop_menu())

@dp.callback_query(F.data == "shop_main")
async def cb_shop_main(callback: CallbackQuery):
    await callback.message.edit_text("üõí –ú–∞–≥–∞–∑–∏–Ω: –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏.", reply_markup=create_shop_menu())
    await callback.answer()

@dp.callback_query(F.data.startswith("shop_item:"))
async def cb_shop_item(callback: CallbackQuery):
    item_id = callback.data.split(":")[1]
    item_name = SHOP_ITEMS[item_id]["name"]
    await callback.message.edit_text(f"–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞ ¬´{item_name}¬ª:", reply_markup=create_item_menu(item_id))
    await callback.answer()

@dp.callback_query(F.data.startswith("buy:"))
async def cb_buy_item(callback: CallbackQuery):
    try:
        _, item_id, days_str = callback.data.split(":")
        days = int(days_str)
        user_id = callback.from_user.id
        item_data = SHOP_ITEMS.get(item_id)
        if not item_data:
            return await callback.answer("–û—à–∏–±–∫–∞: —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        
        price = item_data["prices"].get(days)
        item_name = item_data["name"]
        if price is None:
            return await callback.answer("–û—à–∏–±–∫–∞: —Ü–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
        
        user = await get_user(user_id)
        if not user:
            return await callback.answer("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ /start", show_alert=True)
        
        user_balance = user["balance"] or 0
        if user_balance < price:
            await callback.answer(f"‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ü¶é (—É –≤–∞—Å {user_balance}, —Ç—Ä–µ–±—É–µ—Ç—Å—è {price}).", show_alert=True)
            return
        
        new_balance = user_balance - price
        await update_user_field(user_id, "balance", new_balance)
        
        now_ts = int(datetime.now().timestamp())
        add_seconds = days * 24 * 3600
        field_name = f"{item_id}_end"
        current_end = user[field_name] or 0
        new_end = max(current_end, now_ts) + add_seconds
        await update_user_field(user_id, field_name, new_end)

        # --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        await notify_admins_of_purchase(
            user_id=user_id,
            item_name=item_name,
            days=days,
            new_balance=new_balance,
            new_end_timestamp=new_end
        )
        # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        
        await callback.message.edit_text(f"‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞! –í—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏ ¬´{item_name}¬ª.\n–í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {new_balance} ü¶é")
        await callback.answer()
        
    except Exception as e:
        logger.exception(f"Error in buy handler: {e}")
        await callback.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ.", show_alert=True)

# --- –°–ò–°–¢–ï–ú–ê –ü–û–ü–û–õ–ù–ï–ù–ò–Ø –ß–ï–†–ï–ó TELEGRAM STARS ---
@dp.message(or_f(Command("topup", "–ø–æ–ø–æ–ª–Ω–∏—Ç—å"), F.text.lower().in_(['topup', '–ø–æ–ø–æ–ª–Ω–∏—Ç—å'])))
async def cmd_topup(message: Message, state: FSMContext):
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—â–µ—Ä–æ–∫, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å.\n\n‚ñ´Ô∏è **–ö—É—Ä—Å:** 3 —è—â–µ—Ä–∫–∏ = 1 ‚òÖ\n‚ñ´Ô∏è **–õ–∏–º–∏—Ç—ã:** –æ—Ç 20 –¥–æ 10 000 —è—â–µ—Ä–æ–∫ –∑–∞ —Ä–∞–∑.\n‚ñ´Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫—Ä–∞—Ç–Ω–æ 3.\n\n–î–ª—è –æ—Ç–º–µ–Ω—ã –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ /cancel –∏–ª–∏ –æ—Ç–º–µ–Ω–∞.")
    await state.set_state(TopupStates.waiting_for_amount)

@dp.message(or_f(Command("cancel", "–æ—Ç–º–µ–Ω–∞"), F.text.lower().in_(['cancel', '–æ—Ç–º–µ–Ω–∞'])), F.state == TopupStates.waiting_for_amount)
async def cancel_topup(message: Message, state: FSMContext):
    await message.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    await state.clear()

@dp.message(TopupStates.waiting_for_amount)
async def process_topup_amount(message: Message, state: FSMContext):
    try:
        lizards_to_buy = int(message.text)
    except ValueError:
        return await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.")
    if not (20 <= lizards_to_buy <= 10000):
        return await message.answer("‚ùå –í—ã –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å –æ—Ç 20 –¥–æ 10 000 —è—â–µ—Ä–æ–∫ –∑–∞ —Ä–∞–∑.")
    if lizards_to_buy % 3 != 0:
        lower = (lizards_to_buy // 3) * 3
        upper = lower + 3
        return await message.answer(f"‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—â–µ—Ä–æ–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫—Ä–∞—Ç–Ω–æ 3.\n\n–í—ã –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, {lower if lower >= 20 else upper} –∏–ª–∏ {upper} ü¶é.")
    stars_price = lizards_to_buy // 3
    await state.clear()
    await bot.send_invoice(chat_id=message.from_user.id, title=f"–ü–æ–∫—É–ø–∫–∞ {lizards_to_buy} ü¶é", description=f"–ü–∞–∫–µ—Ç –∏–∑ {lizards_to_buy} —è—â–µ—Ä–æ–∫ –¥–ª—è –≤–∞—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –≤ –±–æ—Ç–µ.", payload=f"lizard_topup:{message.from_user.id}:{lizards_to_buy}", currency="XTR", prices=[LabeledPrice(label=f"{lizards_to_buy} ü¶é", amount=stars_price)])

@dp.pre_checkout_query()
async def pre_checkout_query_handler(pre_checkout_query: PreCheckoutQuery):
    await bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)

@dp.message(F.successful_payment)
async def successful_payment_handler(message: Message):
    try:
        payload = message.successful_payment.invoice_payload
        _, user_id_str, lizards_str = payload.split(":")
        user_id = int(user_id_str)
        lizards_to_add = int(lizards_str)
        await add_user(user_id, message.from_user.username or message.from_user.full_name)
        user = await get_user(user_id)
        current_balance = user['balance'] or 0
        new_balance = current_balance + lizards_to_add
        await update_user_field(user_id, 'balance', new_balance)
        await bot.send_message(chat_id=user_id, text=f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n\n–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ: {lizards_to_add} ü¶é\n–í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {new_balance} ü¶é")
    except Exception as e:
        logger.error(f"Error in successful_payment_handler: {e}")
        await bot.send_message(chat_id=message.from_user.id, text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ —è—â–µ—Ä–æ–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")

# --- –°–ò–°–¢–ï–ú–ê –ë–†–ê–ö–û–í ---
@dp.message(or_f(Command("marry", "–∂–µ–Ω–∏—Ç—å"), F.text.lower().in_(['marry', '–∂–µ–Ω–∏—Ç—å'])))
async def cmd_marry(message: Message):
    if message.chat.type == 'private':
        await message.answer("–≠—Ç—É –∫–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø–µ, –æ—Ç–≤–µ—á–∞—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    if not message.reply_to_message or message.reply_to_message.from_user.is_bot or message.reply_to_message.from_user.id == message.from_user.id:
        return await message.reply("–ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        
    proposer = message.from_user
    target = message.reply_to_message.from_user

    await add_user(proposer.id, proposer.username or proposer.full_name)
    await add_user(target.id, target.username or target.full_name)
    proposer_data = await get_user(proposer.id)
    target_data = await get_user(target.id)
    
    if (proposer_data['level'] or 0) < MARRIAGE_MIN_LEVEL:
        return await message.reply(f"‚ùå –î–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –±—Ä–∞–∫ –Ω—É–∂–µ–Ω {MARRIAGE_MIN_LEVEL} —É—Ä–æ–≤–µ–Ω—å. –í–∞—à —É—Ä–æ–≤–µ–Ω—å: {proposer_data['level'] or 0}.")
    if (target_data['level'] or 0) < MARRIAGE_MIN_LEVEL:
        return await message.reply(f"‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target.full_name} –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –±—Ä–∞–∫–∞ ({target_data['level'] or 0}/{MARRIAGE_MIN_LEVEL}).")
    
    if proposer_data['partner_id']:
        return await message.reply("–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.")
    if (proposer_data['balance'] or 0) < MARRIAGE_COST:
        return await message.reply(f"‚ùå –î–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω—É–∂–Ω–æ {MARRIAGE_COST} ü¶é.\n–£ –≤–∞—Å –Ω–∞ –±–∞–ª–∞–Ω—Å–µ: {proposer_data['balance'] or 0} ü¶é.")
    if target_data['partner_id']:
        return await message.reply(f"{target.full_name} —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.")
    if target_data['proposal_from_id']:
        return await message.reply(f"–£ {target.full_name} —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–∞.")

    kb = InlineKeyboardBuilder()
    kb.add(types.InlineKeyboardButton(text="–î–∞, —è —É–≤–µ—Ä–µ–Ω", callback_data=f"marry_confirm:{proposer.id}:{target.id}"))
    kb.add(types.InlineKeyboardButton(text="–û—Ç–º–µ–Ω–∞", callback_data="marry_cancel"))
    target_mention = await get_user_mention_by_id(target.id)
    await message.reply(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ {target_mention}?\n–°—Ç–æ–∏–º–æ—Å—Ç—å —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è: {MARRIAGE_COST} ü¶é.\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.", reply_markup=kb.as_markup(), parse_mode="HTML")

@dp.message(or_f(Command("accept", "–ø—Ä–∏–Ω—è—Ç—å"), F.text.lower().in_(['accept', '–ø—Ä–∏–Ω—è—Ç—å'])))
async def cmd_accept(message: Message):
    user_id = message.from_user.id
    await add_user(user_id, message.from_user.username or message.from_user.full_name)
    user_data = await get_user(user_id)
    if not user_data['proposal_from_id']:
        return await message.reply("–í–∞–º –Ω–∏–∫—Ç–æ –Ω–µ –¥–µ–ª–∞–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.")
    proposer_id = user_data['proposal_from_id']
    proposer_data = await get_user(proposer_id)
    if not proposer_data or proposer_data['partner_id']:
        await message.reply("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return await update_user_field(user_id, "proposal_from_id", 0)
        
    await update_user_field(user_id, "partner_id", proposer_id)
    await update_user_field(proposer_id, "partner_id", user_id)
    await update_user_field(user_id, "proposal_from_id", 0)
    user_mention = await get_user_mention_by_id(user_id)
    proposer_mention = await get_user_mention_by_id(proposer_id)
    await message.answer(f"üíñ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! {proposer_mention} –∏ {user_mention} —Ç–µ–ø–µ—Ä—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Å–æ—Å—Ç–æ—è—Ç –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö! üíñ", parse_mode="HTML")

@dp.message(or_f(Command("divorce", "—Ä–∞–∑–≤–æ–¥"), F.text.lower().in_(['divorce', '—Ä–∞–∑–≤–æ–¥'])))
async def cmd_divorce(message: Message):
    user_id = message.from_user.id
    await add_user(user_id, message.from_user.username or message.from_user.full_name)
    user_data = await get_user(user_id)
    if not user_data['partner_id']:
        return await message.reply("–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö, –Ω–µ–∫–æ–≥–æ –±—Ä–æ—Å–∞—Ç—å.")
    kb = InlineKeyboardBuilder()
    kb.add(types.InlineKeyboardButton(text="–î–∞, —è —Ö–æ—á—É —Ä–∞–∑–≤–µ—Å—Ç–∏—Å—å", callback_data="confirm_divorce"))
    kb.add(types.InlineKeyboardButton(text="–û—Ç–º–µ–Ω–∞", callback_data="cancel_divorce"))
    await message.reply("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ—Ä–≤–∞—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.", reply_markup=kb.as_markup())

@dp.callback_query(F.data.startswith("marry_confirm:"))
async def confirm_marry(callback: CallbackQuery):
    _, proposer_id_str, target_id_str = callback.data.split(":")
    proposer_id = int(proposer_id_str)
    if callback.from_user.id != proposer_id:
        return await callback.answer("–≠—Ç–æ –Ω–µ –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!", show_alert=True)
    target_id = int(target_id_str)
    proposer_data = await get_user(proposer_id)
    target_data = await get_user(target_id)
    if not proposer_data or not target_data:
        await callback.message.edit_text("–û—à–∏–±–∫–∞: –æ–¥–∏–Ω –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return await callback.answer()
    if (proposer_data['balance'] or 0) < MARRIAGE_COST:
        await callback.message.edit_text(f"‚ùå –£–ø—Å! –ù–∞ –≤–∞—à–µ–º —Å—á–µ—Ç—É –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è {MARRIAGE_COST} ü¶é.")
        return await callback.answer()
    if target_data['partner_id'] or target_data['proposal_from_id']:
        await callback.message.edit_text("‚ùå –£–ø—Å! –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø–æ–ª—É—á–∏–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –≤—Å—Ç—É–ø–∏–ª –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.")
        return await callback.answer()
    try:
        new_balance = (proposer_data['balance'] or 0) - MARRIAGE_COST
        await update_user_field(proposer_id, "balance", new_balance)
        await update_user_field(target_id, "proposal_from_id", proposer_id)
        proposer_mention = await get_user_mention_by_id(proposer_id)
        target_mention = await get_user_mention_by_id(target_id)
        await callback.message.edit_text("–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
        await callback.message.answer(f"üíç {target_mention}, –≤–∞–º –ø–æ—Å—Ç—É–ø–∏–ª–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–∏ –∏ —Å–µ—Ä–¥—Ü–∞ –æ—Ç {proposer_mention}!\n\n–ß—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –µ–≥–æ, –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É `/accept` –∏–ª–∏ `–ø—Ä–∏–Ω—è—Ç—å`.", parse_mode="HTML")
        await callback.answer()
    except Exception as e:
        logger.error(f"Error during marriage confirmation: {e}")
        await callback.message.edit_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        await callback.answer()

@dp.callback_query(F.data == "marry_cancel")
async def cancel_marry(callback: CallbackQuery):
    await callback.message.edit_text("–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    await callback.answer()

@dp.callback_query(F.data == "confirm_divorce")
async def confirm_divorce(callback: CallbackQuery):
    user_id = callback.from_user.id
    user_data = await get_user(user_id)
    if not user_data or not user_data['partner_id']:
        await callback.message.edit_text("–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.")
        return await callback.answer()
    partner_id = user_data['partner_id']
    await update_user_field(user_id, "partner_id", 0)
    await update_user_field(partner_id, "partner_id", 0)
    user_mention = await get_user_mention_by_id(user_id)
    partner_mention = await get_user_mention_by_id(partner_id)
    await callback.message.edit_text("–û—Ç–Ω–æ—à–µ–Ω–∏—è —Ä–∞–∑–æ—Ä–≤–∞–Ω—ã.")
    await callback.message.answer(f"üíî {user_mention} –∏ {partner_mention} –±–æ–ª—å—à–µ –Ω–µ –≤–º–µ—Å—Ç–µ. üíî", parse_mode="HTML")
    await callback.answer()

@dp.callback_query(F.data == "cancel_divorce")
async def cancel_divorce(callback: CallbackQuery):
    await callback.message.edit_text("–†–∞–∑–≤–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω. –í–∞—à–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!")
    await callback.answer()



# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö –ê–ö–¢–ò–í–ù–û–°–¢–ò (–î–õ–Ø –ö–û–ú–ê–ù–î–´ /PING)---
# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö –ê–ö–¢–ò–í–ù–û–°–¢–ò ---
@dp.message(or_f(Command("ping", "–ø–∏–Ω–≥"), F.text.lower().in_(['ping', '–ø–∏–Ω–≥'])))
async def cmd_ping(message: Message):
    if message.chat.type not in {'group', 'supergroup'}:
        await message.reply("–≠—Ç—É –∫–æ–º–∞–Ω–¥—É –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö.")
        return
    try:
        member = await bot.get_chat_member(message.chat.id, message.from_user.id)
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id} –≤ —á–∞—Ç–µ {message.chat.id}: {e}")
        return
    if member.status not in {ChatMemberStatus.ADMINISTRATOR, ChatMemberStatus.CREATOR}:
        return
    chat_id = message.chat.id
    pinger_id = message.from_user.id
    if chat_id not in recent_users_activity or len(recent_users_activity[chat_id]) <= 1:
        await message.reply("–Ø –µ—â–µ –Ω–µ –≤–∏–¥–µ–ª –∑–¥–µ—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –Ω–µ–∫–æ–≥–æ –ø–∏–Ω–≥–æ–≤–∞—Ç—å.")
        return
    now = datetime.now().timestamp()
    active_users_ids = [uid for uid, last_seen in recent_users_activity[chat_id].items() if (now - last_seen) < 86400 and uid != pinger_id]
    if not active_users_ids:
        await message.reply("–ö—Ä–æ–º–µ –≤–∞—Å –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∏–∫—Ç–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏—á–∞–ª.")
        return
    target_id = random.choice(active_users_ids)
    try:
        target_mention = await get_user_mention_by_id(target_id)
        pinger_mention = await get_user_mention_by_id(pinger_id)
        ping_text = random.choice(PING_MESSAGES)
        await message.answer(f"üìû {target_mention}, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {pinger_mention} —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: ¬´{ping_text}¬ª")
    except Exception as e:
        logger.error(f"Error in ping command while getting user mentions: {e}")
        await message.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–∏–Ω–≥–∞.")

@dp.message()
async def track_user_activity(message: types.Message):
    if message.chat.type in {'group', 'supergroup'}:
        if not message.from_user.is_bot:
            recent_users_activity.setdefault(message.chat.id, {})
            recent_users_activity[message.chat.id][message.from_user.id] = datetime.now().timestamp()

# --- –ó–ê–ü–£–°–ö –ë–û–¢–ê ---
async def main():
    global db_pool
    await create_pool()
    await init_db()
    await populate_questions()
    bot.default_parse_mode = "HTML"
    try:
        await dp.start_polling(bot)
    finally:
        if db_pool:
            await db_pool.close()
            logger.info("–ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å PostgreSQL –∑–∞–∫—Ä—ã—Ç.")
        await bot.session.close()

if __name__ == "__main__":
    asyncio.run(main())
